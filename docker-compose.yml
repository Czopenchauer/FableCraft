services:
  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:9.0
    container_name: aspire-dashboard
    ports:
      - "18888:18888"   # Dashboard UI
      - "4317:18889"    # OTLP gRPC endpoint
      - "4318:18890"    # OTLP HTTP endpoint
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
    networks:
      - fablecraft-network

  fablecraftdb:
    image: postgres:18.0
    container_name: fablecraftdb
    ports:
      - "6999:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-fablecraftdb}
    volumes:
      - fablecraft-postgres-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d fablecraftdb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fablecraft-network

  graph-rag-api:
    build:
      context: ./GraphRag
      dockerfile: Dockerfile
    container_name: graph-rag-api
    ports:
      - "8111:8111"
    env_file:
      - ./GraphRag/.env.docker
    # These override env_file values and read from root .env
    environment:
      - LLM_API_KEY=${LLM_API_KEY:?LLM_API_KEY is required - set it in .env}
      - LLM_MODEL=${LLM_MODEL:-gpt-4}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LLM_ENDPOINT=${LLM_ENDPOINT:-}
      - LLM_API_VERSION=${LLM_API_VERSION:-}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-16384}
      - LLM_RATE_LIMIT_ENABLED=${LLM_RATE_LIMIT_ENABLED:-true}
      - LLM_RATE_LIMIT_REQUESTS=${LLM_RATE_LIMIT_REQUESTS:-60}
      - LLM_RATE_LIMIT_INTERVAL=${LLM_RATE_LIMIT_INTERVAL:-60}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-large}
      - EMBEDDING_ENDPOINT=${EMBEDDING_ENDPOINT:-}
      - EMBEDDING_API_VERSION=${EMBEDDING_API_VERSION:-}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-3072}
      - EMBEDDING_MAX_TOKENS=${EMBEDDING_MAX_TOKENS:-8191}
      - EMBEDDING_BATCH_SIZE=${EMBEDDING_BATCH_SIZE:-36}
      - HUGGINGFACE_TOKENIZER=${HUGGINGFACE_TOKENIZER:-}
    volumes:
      - ./cognee/data:/app/cognee/data
      - ./cognee/system:/app/cognee/system
      - ./visualization:/app/visualization
      - ./data-store:/app/data-store
    depends_on:
      - aspire-dashboard
    networks:
      - fablecraft-network

  fablecraft-server:
    build:
      context: .
      dockerfile: Server/FableCraft.Server/Dockerfile
    container_name: fablecraft-server
    ports:
      - "5000:8080"
    env_file:
      - ./Server/FableCraft.Server/.env.docker
    environment:
      - ConnectionStrings__fablecraftdb=Host=fablecraftdb;Port=5432;Database=fablecraftdb;Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres}
      - ConnectionStrings__graph-rag-api=http://graph-rag-api:8111
      - VisualizationPath=/app/visualization
    volumes:
      - ./data-store:/app/data-store
      - ./logs:/app/logs
      - ./Prompts:/app/prompts-root
      - ./visualization:/app/visualization
    depends_on:
      fablecraftdb:
        condition: service_healthy
      graph-rag-api:
        condition: service_started
      aspire-dashboard:
        condition: service_started
    networks:
      - fablecraft-network

  fablecraft-client:
    build:
      context: ./fablecraft.client
      dockerfile: Dockerfile
    container_name: fablecraft-client
    ports:
      - "4200:80"
    depends_on:
      - fablecraft-server
    networks:
      - fablecraft-network

volumes:
  fablecraft-postgres-data:

networks:
  fablecraft-network:
    driver: bridge
