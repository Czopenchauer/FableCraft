services:
  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:9.0
    container_name: aspire-dashboard
    ports:
      - "18888:18888"   # Dashboard UI
      - "4317:18889"    # OTLP gRPC endpoint
      - "4318:18890"    # OTLP HTTP endpoint
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
    networks:
      - fablecraft-network

  fablecraftdb:
    image: postgres:18.0
    container_name: fablecraftdb
    ports:
      - "6999:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-fablecraftdb}
    volumes:
      - fablecraft-postgres-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d fablecraftdb"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fablecraft-network

  fablecraft-server:
    build:
      context: .
      dockerfile: Server/FableCraft.Server/Dockerfile
    container_name: fablecraft-server
    ports:
      - "5000:8080"
    env_file:
      - ./Server/FableCraft.Server/.env.docker
    environment:
      - ConnectionStrings__fablecraftdb=Host=fablecraftdb;Port=5432;Database=fablecraftdb;Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres}
      - VisualizationPath=/app/visualization
      - GraphService__DataStoreHostPath=${FABLECRAFT_PROJECT_PATH}/data-store
      - GraphService__VisualizationHostPath=${FABLECRAFT_PROJECT_PATH}/visualization
      - GraphService__ExportsHostPath=${FABLECRAFT_PROJECT_PATH}/exports
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data-store:/app/data-store
      - ./logs:/app/logs
      - ./Prompts:/app/prompts-root
      - ./visualization:/app/visualization
      - ./exports:/app/exports
    depends_on:
      fablecraftdb:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - fablecraft-network

  fablecraft-client:
    build:
      context: ./fablecraft.client
      dockerfile: Dockerfile
    container_name: fablecraft-client
    ports:
      - "4200:80"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - fablecraft-server
    networks:
      - fablecraft-network

volumes:
  fablecraft-postgres-data:
  cognee-data:

networks:
  fablecraft-network:
    name: fablecraft-network
    driver: bridge
