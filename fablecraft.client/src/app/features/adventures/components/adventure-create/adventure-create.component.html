<div class="create-container">
  <div class="create-content">
    <!-- Header Section -->
    <div class="header-section">
      <button class="back-button" routerLink="/">
        <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
          <path [attr.d]="'M15 19l-7-7 7-7'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                [attr.stroke-width]="2"></path>
        </svg>
        Back to Home
      </button>

      <h1 class="page-title">Create New Adventure</h1>
      <p class="page-subtitle">
        Define your world, create your character, and embark on an epic journey shaped by your imagination.
      </p>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="spinner"></div>
      <p>Loading settings...</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-message">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"
              stroke-width="2"></path>
      </svg>
      <span>{{ errorMessage }}</span>
    </div>

    <!-- Adventure Creation Form -->
    <form (ngSubmit)="onSubmit()" *ngIf="!isLoading" [formGroup]="adventureForm" class="adventure-form">

      <!-- Basic Information Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">Basic Information</h2>
          <p class="section-subtitle">Name your adventure and set the scene</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="adventureName">Adventure Name *</label>
          <input
            [class.input-error]="isFieldInvalid('name')"
            class="form-input"
            formControlName="name"
            id="adventureName"
            placeholder="Enter a memorable name for your adventure"
            type="text"
          />
          <span *ngIf="isFieldInvalid('name')" class="error-text">
            {{ getFieldError('name') }}
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="referenceTime">Reference Time *</label>
          <input
            [class.input-error]="isFieldInvalid('referenceTime')"
            class="form-input"
            formControlName="referenceTime"
            id="referenceTime"
            placeholder="e.g., 11-11-2020, 04-04-999"
            type="text"
          />
          <span class="help-text">Initial date for the story tracker</span>
          <span *ngIf="isFieldInvalid('referenceTime')" class="error-text">
            {{ getFieldError('referenceTime') }}
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="firstSceneDescription">First Scene Description *</label>
          <textarea
            [class.input-error]="isFieldInvalid('firstSceneDescription')"
            class="form-textarea"
            formControlName="firstSceneDescription"
            id="firstSceneDescription"
            placeholder="Describe the opening scene of your adventure. Where does your story begin?"
            rows="3"
          ></textarea>
          <span *ngIf="isFieldInvalid('firstSceneDescription')" class="error-text">
            {{ getFieldError('firstSceneDescription') }}
          </span>
        </div>
      </div>

      <!-- Character Section -->
      <div class="form-section" formGroupName="mainCharacter">
        <div class="section-header">
          <h2 class="section-title">Character</h2>
          <p class="section-subtitle">Create your protagonist</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="characterName">Character Name *</label>
          <input
            [class.input-error]="isFieldInvalid('name', mainCharacterGroup)"
            class="form-input"
            formControlName="name"
            id="characterName"
            placeholder="Your character's name"
            type="text"
          />
          <span *ngIf="isFieldInvalid('name', mainCharacterGroup)" class="error-text">
            {{ getFieldError('name', mainCharacterGroup) }}
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="characterDescription">Character Description *</label>
          <textarea
            [class.input-error]="isFieldInvalid('description', mainCharacterGroup)"
            class="form-textarea"
            formControlName="description"
            id="characterDescription"
            placeholder="Physical appearance, personality, skills, motivations, background..."
            rows="3"
          ></textarea>
          <span *ngIf="isFieldInvalid('description', mainCharacterGroup)" class="error-text">
            {{ getFieldError('description', mainCharacterGroup) }}
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="initialTrackerJson">Initial Tracker State (Optional - JSON)</label>
          <textarea
            class="form-textarea code-input"
            formControlName="initialTrackerJson"
            id="initialTrackerJson"
            placeholder='{"name": "CharacterName", "appearance": "...", "generalBuild": "..."}'
            rows="4"
          ></textarea>
          <span class="help-text">Optional JSON to pre-define the main character's tracker state for the first scene. Leave empty to let the AI initialize it.</span>
        </div>
      </div>

      <!-- Configuration Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">Configuration</h2>
          <p class="section-subtitle">Select your adventure settings</p>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="worldbookId">Worldbook</label>
            <select
              class="form-select"
              formControlName="worldbookId"
              id="worldbookId"
            >
              <option [ngValue]="null">-- None --</option>
              <option *ngFor="let worldbook of worldbooks" [ngValue]="worldbook.id">
                {{ worldbook.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="trackerDefinitionId">Tracker Definition *</label>
            <select
              [class.input-error]="isFieldInvalid('trackerDefinitionId')"
              class="form-select"
              formControlName="trackerDefinitionId"
              id="trackerDefinitionId"
            >
              <option value="">-- Select Tracker --</option>
              <option *ngFor="let tracker of trackerDefinitions" [ngValue]="tracker.id">
                {{ tracker.name }}
              </option>
            </select>
            <span *ngIf="isFieldInvalid('trackerDefinitionId')" class="error-text">
              {{ getFieldError('trackerDefinitionId') }}
            </span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="graphRagSettingsId">GraphRAG Settings</label>
          <select
            class="form-select"
            formControlName="graphRagSettingsId"
            id="graphRagSettingsId"
          >
            <option [ngValue]="null">-- None (inherit from worldbook) --</option>
            <option *ngFor="let settings of graphRagSettingsOptions" [ngValue]="settings.id">
              {{ settings.name }}
            </option>
          </select>
          <span class="help-text">Optional. Select GraphRAG settings for knowledge graph queries. Auto-populated from selected worldbook.</span>
        </div>

        <div class="form-group">
          <label class="form-label">Prompt Path *</label>
          <app-directory-browser
            (pathSelected)="onPromptPathSelected($event)"
            [currentPath]="currentPromptPath"
            [disabled]="isSubmitting"
          ></app-directory-browser>
          <span class="help-text">Path to the directory containing agent prompt templates. You can customize your world by adding StoryBible.md and WorldSettings.md files to this directory.</span>
          <span *ngIf="isFieldInvalid('promptPath')" class="error-text">
            {{ getFieldError('promptPath') }}
          </span>
        </div>
      </div>

      <!-- Extra Lore Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">Extra Lore (Optional)</h2>
          <p class="section-subtitle">Add custom lore entries that will be used in the first scene</p>
        </div>

        <div class="extra-lore-entries" formArrayName="extraLoreEntries">
          <div *ngFor="let loreEntry of extraLoreArray.controls; let i = index" [formGroupName]="i" class="extra-lore-entry">
            <div class="lore-entry-header">
              <span class="lore-entry-number">Entry {{ i + 1 }}</span>
              <button
                (click)="removeExtraLoreEntry(i)"
                class="btn-remove"
                type="button"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                </svg>
              </button>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" [for]="'loreTitle-' + i">Title *</label>
                <input
                  class="form-input"
                  formControlName="title"
                  [id]="'loreTitle-' + i"
                  placeholder="Lore entry title"
                  type="text"
                />
              </div>

              <div class="form-group">
                <label class="form-label" [for]="'loreCategory-' + i">Category *</label>
                <select
                  class="form-select"
                  formControlName="category"
                  [id]="'loreCategory-' + i"
                >
                  <option value="Lore">Lore</option>
                  <option value="Location">Location</option>
                  <option value="Item">Item</option>
                  <option value="Character">Character</option>
                  <option value="Event">Event</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" [for]="'loreContent-' + i">Content *</label>
              <textarea
                class="form-textarea"
                formControlName="content"
                [id]="'loreContent-' + i"
                placeholder="Describe this lore entry in detail..."
                rows="3"
              ></textarea>
            </div>
          </div>
        </div>

        <button
          (click)="addExtraLoreEntry()"
          class="btn btn-secondary add-lore-btn"
          type="button"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
          Add Lore Entry
        </button>
      </div>

      <!-- Custom Characters Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">Custom Characters (Optional)</h2>
          <p class="section-subtitle">Pre-define NPCs that will exist from the start of the adventure</p>
        </div>

        <div class="custom-characters-entries" formArrayName="customCharacters">
          <div *ngFor="let character of customCharactersArray.controls; let i = index" [formGroupName]="i" class="custom-character-entry">
            <div class="character-entry-header">
              <span class="character-entry-number">Character {{ i + 1 }}</span>
              <button
                (click)="removeCustomCharacter(i)"
                class="btn-remove"
                type="button"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                </svg>
              </button>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label" [for]="'charName-' + i">Name *</label>
                <input
                  class="form-input"
                  formControlName="name"
                  [id]="'charName-' + i"
                  placeholder="Character name"
                  type="text"
                />
              </div>

              <div class="form-group">
                <label class="form-label" [for]="'charImportance-' + i">Importance *</label>
                <select
                  class="form-select"
                  formControlName="importance"
                  [id]="'charImportance-' + i"
                >
                  <option value="arc_important">Arc Important</option>
                  <option value="significant">Significant</option>
                  <option value="background">Background</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" [for]="'charDescription-' + i">Description *</label>
              <textarea
                class="form-textarea"
                formControlName="description"
                [id]="'charDescription-' + i"
                placeholder="Physical appearance, personality, role in the story..."
                rows="3"
              ></textarea>
            </div>

            <div class="form-group">
              <label class="form-label" [for]="'charStats-' + i">Character Stats (JSON)</label>
              <textarea
                class="form-textarea code-input"
                formControlName="characterStatsJson"
                [id]="'charStats-' + i"
                placeholder='{"name": "", "motivations": null, "routine": null}'
                rows="4"
              ></textarea>
              <span class="help-text">Character profile: motivations, routine, and other stats</span>
            </div>

            <div class="form-group">
              <label class="form-label" [for]="'charTracker-' + i">Character Tracker (JSON)</label>
              <textarea
                class="form-textarea code-input"
                formControlName="characterTrackerJson"
                [id]="'charTracker-' + i"
                placeholder='{"name": "", "location": "", "appearance": ""}'
                rows="4"
              ></textarea>
              <span class="help-text">Character tracker state: location, appearance, etc.</span>
            </div>

            <!-- Relationships within this character -->
            <div class="relationships-section">
              <div class="relationships-header">
                <span class="relationships-title">Relationships</span>
                <button
                  (click)="addRelationship(i)"
                  class="btn btn-small btn-secondary"
                  type="button"
                >
                  + Add Relationship
                </button>
              </div>

              <div formArrayName="relationships">
                <div *ngFor="let rel of getCharacterRelationships(i).controls; let j = index" [formGroupName]="j" class="relationship-entry">
                  <div class="relationship-row">
                    <div class="form-group">
                      <label class="form-label" [for]="'relTarget-' + i + '-' + j">Target Character *</label>
                      <input
                        class="form-input"
                        formControlName="targetCharacterName"
                        [id]="'relTarget-' + i + '-' + j"
                        placeholder="Name of the other character"
                        type="text"
                      />
                    </div>
                    <button
                      (click)="removeRelationship(i, j)"
                      class="btn-remove"
                      type="button"
                    >
                      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                      </svg>
                    </button>
                  </div>

                  <div class="form-group">
                    <label class="form-label" [for]="'relDynamic-' + i + '-' + j">Dynamic *</label>
                    <textarea
                      class="form-textarea"
                      formControlName="dynamic"
                      [id]="'relDynamic-' + i + '-' + j"
                      placeholder="2-4 sentences: How they feel about this person and why..."
                      rows="2"
                    ></textarea>
                  </div>

                  <div class="form-group">
                    <label class="form-label" [for]="'relData-' + i + '-' + j">Relationship Data (JSON)</label>
                    <textarea
                      class="form-textarea code-input"
                      formControlName="dataJson"
                      [id]="'relData-' + i + '-' + j"
                      placeholder='{"foundation": "", "stance": "", "trust": ""}'
                      rows="3"
                    ></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <button
          (click)="addCustomCharacter()"
          class="btn btn-secondary add-character-btn"
          type="button"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
          Add Custom Character
        </button>
      </div>

      <!-- Agent LLM Presets Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">Agent LLM Presets</h2>
          <p class="section-subtitle">Assign LLM presets to each agent</p>
        </div>

        <!-- Apply to all agents -->
        <div class="apply-all-row">
          <label class="form-label" for="applyToAll">Apply to all agents</label>
          <div class="apply-all-controls">
            <select
              (change)="applyPresetToAll($any($event.target).value)"
              class="form-select"
              id="applyToAll"
            >
              <option value="">-- Select preset to apply --</option>
              <option *ngFor="let preset of llmPresets" [value]="preset.id">
                {{ preset.name }}
              </option>
            </select>
            <span class="help-text">Select a preset to assign it to all agents at once</span>
          </div>
        </div>

        <div class="agents-grid" formGroupName="agentPresets">
          <div *ngFor="let agentName of agentNames" class="agent-preset-row">
            <label [for]="'agent-' + agentName" class="agent-label">{{ formatAgentName(agentName) }} *</label>
            <select
              [class.input-error]="isFieldInvalid(agentName, agentPresetsGroup)"
              [formControlName]="agentName"
              [id]="'agent-' + agentName"
              class="form-select agent-select"
            >
              <option value="">-- Select LLM --</option>
              <option *ngFor="let preset of llmPresets" [ngValue]="preset.id">
                {{ preset.name }}
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button
          class="btn btn-secondary"
          routerLink="/"
          type="button"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
          Cancel
        </button>

        <button
          [disabled]="isSubmitting"
          class="btn btn-primary"
          type="submit"
        >
          <span *ngIf="!isSubmitting">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="2"></path>
            </svg>
            Create Adventure
          </span>
          <span *ngIf="isSubmitting" class="submit-loading">
            <span class="spinner-small"></span>
            Creating...
          </span>
        </button>
      </div>
    </form>
  </div>
</div>
