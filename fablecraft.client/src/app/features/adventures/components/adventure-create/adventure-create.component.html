<div class="create-container">
  <div class="create-content">
    <!-- Header Section -->
    <div class="header-section">
      <button class="back-button" routerLink="/">
        <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
          <path [attr.d]="'M15 19l-7-7 7-7'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                [attr.stroke-width]="2"></path>
        </svg>
        Back to Home
      </button>

      <h1 class="page-title">Create New Adventure</h1>
      <p class="page-subtitle">
        Define your world, create your character, and embark on an epic journey shaped by your imagination.
      </p>
    </div>

    <!-- Initial Step Cards - Click to Start -->
    <div *ngIf="currentStep === 0">
      <div class="creation-steps">
        <div class="step-card">
          <div class="step-number">1</div>
          <div class="step-content">
            <h2 class="step-title">World Building</h2>
            <p class="step-description">
              Describe your world's setting, magic systems, civilizations, and unique characteristics.
              The AI will help bring your vision to life with rich details and consistent lore.
            </p>
          </div>
        </div>

        <div class="step-card">
          <div class="step-number">2</div>
          <div class="step-content">
            <h2 class="step-title">Character Creation</h2>
            <p class="step-description">
              Define your protagonist - their background, skills, motivations, and personality.
              This character will be your avatar in the adventures to come.
            </p>
          </div>
        </div>

        <div class="step-card">
          <div class="step-number">3</div>
          <div class="step-content">
            <h2 class="step-title">Starting Scene</h2>
            <p class="step-description">
              Set the stage for your adventure. Where does your story begin?
              What situation or conflict launches you into this journey?
            </p>
          </div>
        </div>
      </div>

      <div class="start-section">
        <div class="adventure-name-input-container">
          <label class="adventure-name-label" for="adventureNameStart">Adventure Name *</label>
          <input
            [class.input-error]="isFieldInvalid('name')"
            [formControl]="$any(adventureForm.get('name'))"
            class="adventure-name-input"
            id="adventureNameStart"
            placeholder="Enter a memorable name for your adventure"
            type="text"
          />
          <span *ngIf="isFieldInvalid('name')" class="error-text">
            {{ getFieldError('name') }}
          </span>
        </div>

        <button (click)="startAdventureCreation()" class="btn btn-primary btn-start">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
          Start Creating Your Adventure
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="spinner"></div>
      <p>Loading form...</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-message">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"
              stroke-width="2"></path>
      </svg>
      <span>{{ errorMessage }}</span>
    </div>

    <!-- Adventure Creation Form -->
    <form (ngSubmit)="onSubmit()" *ngIf="!isLoading && currentStep > 0" [formGroup]="adventureForm"
          class="adventure-form">

      <!-- Progress Indicator -->
      <div class="progress-container">
        <div class="progress-steps">
          <div *ngFor="let step of [1, 2, 3]; let i = index"
               [class.active]="currentStep === step"
               [class.completed]="currentStep > step"
               class="progress-step">
            <div class="progress-circle">
              <span *ngIf="currentStep <= step">{{ step }}</span>
              <svg *ngIf="currentStep > step" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"></path>
              </svg>
            </div>
            <span class="progress-label">Step {{ step }}</span>
          </div>
        </div>
        <div class="progress-bar">
          <div [style.width.%]="(currentStep / totalSteps) * 100" class="progress-fill"></div>
        </div>
      </div>

      <!-- Step Header -->
      <div class="step-header">
        <h2 class="step-form-title">{{ getStepTitle() }}</h2>
        <p class="step-form-description">{{ getStepDescription() }}</p>
      </div>

      <!-- Step 1: World Building (Lorebook) -->
      <div *ngIf="currentStep === 1" class="form-section">
        <!-- AI Generation Info and Controls -->
        <div class="ai-generation-info">
          <div class="info-banner">
            <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"></path>
            </svg>
            <div class="info-content">
              <h4>AI-Powered World Building</h4>
              <p>You can generate lorebook entries using AI. The AI will create content for each category sequentially,
                using previously generated entries as context.</p>
            </div>
          </div>

          <div class="generation-controls">
            <div class="form-group">
              <label class="form-label" for="customInstruction">Custom Instructions *</label>
              <textarea
                [(ngModel)]="customInstruction"
                [disabled]="isGenerating"
                [ngModelOptions]="{standalone: true}"
                class="form-textarea"
                id="customInstruction"
                placeholder="Add any specific instructions or themes for the AI to follow when generating lorebook entries..."
                rows="3"
              ></textarea>
            </div>

            <div class="generation-buttons">
              <button
                (click)="startLorebookGeneration()"
                [disabled]="isGenerateAllDisabled()"
                class="btn btn-primary"
                type="button"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linecap="round" stroke-linejoin="round"
                        stroke-width="2"></path>
                </svg>
                Generate All Lorebooks
              </button>

              <button
                (click)="stopLorebookGeneration()"
                *ngIf="isGenerating"
                class="btn btn-secondary"
                type="button"
              >
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                </svg>
                Stop Generation
              </button>
            </div>
          </div>
        </div>

        <!-- Lorebook Entries -->
        <div formArrayName="lorebook">
          <div *ngFor="let entry of lorebookEntries.controls; let i = index"
               [class.generating]="isLorebookGenerating(i)"
               [formGroupName]="i"
               class="lorebook-entry">
            <div class="lorebook-header">
              <h3 class="lorebook-category">{{ getLorebookAt(i).get('category')?.value }}</h3>
              <div class="lorebook-actions">
                <button
                  (click)="generateSingleLorebook(i)"
                  [disabled]="isLorebookGenerating(i) || isGenerating"
                  [title]="'Generate ' + getLorebookAt(i).get('category')?.value + ' using AI. You can provide custom instructions in the text area.'"
                  class="btn-generate-lorebook"
                  type="button"
                >
                  <svg *ngIf="!isLorebookGenerating(i)" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linecap="round" stroke-linejoin="round"
                          stroke-width="2"></path>
                  </svg>
                  <span *ngIf="isLorebookGenerating(i)" class="spinner-tiny"></span>
                </button>
                <span *ngIf="getLorebookState(i)?.status === 'pending'" class="status-badge pending">
                  Waiting...
                </span>
                <span *ngIf="getLorebookState(i)?.status === 'error'" class="status-badge error">
                  Error
                </span>
              </div>
            </div>
            <p class="lorebook-description">{{ getLorebookAt(i).get('description')?.value }}</p>

            <div class="form-group lorebook-textarea-wrapper">
              <div *ngIf="isLorebookGenerating(i)" class="textarea-overlay">
                <div class="spinner"></div>
              </div>
              <textarea
                [disabled]="isLorebookGenerating(i)"
                [placeholder]="'Describe ' + getLorebookAt(i).get('category')?.value + '...'"
                class="form-textarea lorebook-textarea"
                formControlName="content"
                rows="4"
              ></textarea>
            </div>

            <div *ngIf="getLorebookState(i)?.error" class="error-message">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"></path>
              </svg>
              <span>{{ getLorebookState(i)?.error }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Character Creation -->
      <div *ngIf="currentStep === 2" class="form-section" formGroupName="character">

        <div class="form-group">
          <label class="form-label" for="characterName">Character Name *</label>
          <input
            [class.input-error]="isFieldInvalid('name', characterGroup)"
            class="form-input"
            formControlName="name"
            id="characterName"
            placeholder="Your character's name"
            type="text"
          />
          <span *ngIf="isFieldInvalid('name', characterGroup)" class="error-text">
            {{ getFieldError('name', characterGroup) }}
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="characterDescription">Character Description *</label>
          <textarea
            [class.input-error]="isFieldInvalid('description', characterGroup)"
            class="form-textarea"
            formControlName="description"
            id="characterDescription"
            placeholder="Physical appearance, personality, skills, motivations..."
            rows="4"
          ></textarea>
          <span *ngIf="isFieldInvalid('description', characterGroup)" class="error-text">
            {{ getFieldError('description', characterGroup) }}
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="characterBackground">Character Background *</label>
          <textarea
            [class.input-error]="isFieldInvalid('background', characterGroup)"
            class="form-textarea"
            formControlName="background"
            id="characterBackground"
            placeholder="Where did your character come from? What shaped them?"
            rows="4"
          ></textarea>
          <span *ngIf="isFieldInvalid('background', characterGroup)" class="error-text">
            {{ getFieldError('background', characterGroup) }}
          </span>
        </div>
      </div>

      <!-- Step 3: Starting Scene -->
      <div *ngIf="currentStep === 3" class="form-section">
        <div class="form-group">
          <label class="form-label" for="authorNotes">Author Notes (Style Guide) *</label>
          <textarea
            [class.input-error]="isFieldInvalid('authorNotes')"
            class="form-textarea"
            formControlName="authorNotes"
            id="authorNotes"
            placeholder="Describe the style, tone, and world of your adventure (e.g., 'dark and gritty fantasy with steampunk elements', 'whimsical high fantasy', 'epic heroic saga in a medieval world')..."
            rows="6"
          ></textarea>
          <span *ngIf="isFieldInvalid('authorNotes')" class="error-text">
            {{ getFieldError('authorNotes') }}
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="firstSceneDescription">Starting Scene *</label>
          <textarea
            [class.input-error]="isFieldInvalid('firstSceneDescription')"
            class="form-textarea"
            formControlName="firstSceneDescription"
            id="firstSceneDescription"
            placeholder="Where does your story begin? Describe the initial setting, situation, and immediate objectives..."
            rows="6"
          ></textarea>
          <span *ngIf="isFieldInvalid('firstSceneDescription')" class="error-text">
            {{ getFieldError('firstSceneDescription') }}
          </span>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button
          (click)="currentStep === 1 ? currentStep = 0 : previousStep()"
          [disabled]="isSubmitting"
          class="btn btn-secondary"
          type="button"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
          {{ currentStep === 1 ? 'Cancel' : 'Previous' }}
        </button>

        <button
          (click)="nextStep()"
          *ngIf="currentStep < totalSteps"
          [disabled]="isSubmitting"
          class="btn btn-primary"
          type="button"
        >
          Next
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
        </button>

        <button
          *ngIf="currentStep === totalSteps"
          [disabled]="isSubmitting"
          class="btn btn-primary"
          type="submit"
        >
          <span *ngIf="!isSubmitting">Create Adventure</span>
          <span *ngIf="isSubmitting" class="submit-loading">
            <span class="spinner-small"></span>
            Creating...
          </span>
        </button>
      </div>
    </form>
  </div>
</div>
