<div class="create-container">
  <div class="create-content">
    <!-- Header Section -->
    <div class="header-section">
      <button class="back-button" routerLink="/">
        <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
          <path [attr.d]="'M15 19l-7-7 7-7'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                [attr.stroke-width]="2"></path>
        </svg>
        Back to Home
      </button>

      <h1 class="page-title">Create New Adventure</h1>
      <p class="page-subtitle">
        Define your world, create your character, and embark on an epic journey shaped by your imagination.
      </p>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="spinner"></div>
      <p>Loading settings...</p>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-message">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"
              stroke-width="2"></path>
      </svg>
      <span>{{ errorMessage }}</span>
    </div>

    <!-- Adventure Creation Form -->
    <form (ngSubmit)="onSubmit()" *ngIf="!isLoading" [formGroup]="adventureForm" class="adventure-form">

      <!-- Basic Information Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">Basic Information</h2>
          <p class="section-subtitle">Name your adventure and set the scene</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="adventureName">Adventure Name *</label>
          <input
            [class.input-error]="isFieldInvalid('name')"
            class="form-input"
            formControlName="name"
            id="adventureName"
            placeholder="Enter a memorable name for your adventure"
            type="text"
          />
          <span *ngIf="isFieldInvalid('name')" class="error-text">
            {{ getFieldError('name') }}
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="referenceTime">Reference Time *</label>
          <input
            [class.input-error]="isFieldInvalid('referenceTime')"
            class="form-input"
            formControlName="referenceTime"
            id="referenceTime"
            placeholder="e.g., 11-11-2020, 04-04-999"
            type="text"
          />
          <span class="help-text">Initial date for the story tracker</span>
          <span *ngIf="isFieldInvalid('referenceTime')" class="error-text">
            {{ getFieldError('referenceTime') }}
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="firstSceneDescription">First Scene Description *</label>
          <textarea
            [class.input-error]="isFieldInvalid('firstSceneDescription')"
            class="form-textarea"
            formControlName="firstSceneDescription"
            id="firstSceneDescription"
            placeholder="Describe the opening scene of your adventure. Where does your story begin?"
            rows="3"
          ></textarea>
          <span *ngIf="isFieldInvalid('firstSceneDescription')" class="error-text">
            {{ getFieldError('firstSceneDescription') }}
          </span>
        </div>
      </div>

      <!-- Character Section -->
      <div class="form-section" formGroupName="mainCharacter">
        <div class="section-header">
          <h2 class="section-title">Character</h2>
          <p class="section-subtitle">Create your protagonist</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="characterName">Character Name *</label>
          <input
            [class.input-error]="isFieldInvalid('name', mainCharacterGroup)"
            class="form-input"
            formControlName="name"
            id="characterName"
            placeholder="Your character's name"
            type="text"
          />
          <span *ngIf="isFieldInvalid('name', mainCharacterGroup)" class="error-text">
            {{ getFieldError('name', mainCharacterGroup) }}
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="characterDescription">Character Description *</label>
          <textarea
            [class.input-error]="isFieldInvalid('description', mainCharacterGroup)"
            class="form-textarea"
            formControlName="description"
            id="characterDescription"
            placeholder="Physical appearance, personality, skills, motivations, background..."
            rows="3"
          ></textarea>
          <span *ngIf="isFieldInvalid('description', mainCharacterGroup)" class="error-text">
            {{ getFieldError('description', mainCharacterGroup) }}
          </span>
        </div>
      </div>

      <!-- Configuration Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">Configuration</h2>
          <p class="section-subtitle">Select your adventure settings</p>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="worldbookId">Worldbook</label>
            <select
              class="form-select"
              formControlName="worldbookId"
              id="worldbookId"
            >
              <option [ngValue]="null">-- None --</option>
              <option *ngFor="let worldbook of worldbooks" [ngValue]="worldbook.id">
                {{ worldbook.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="trackerDefinitionId">Tracker Definition *</label>
            <select
              [class.input-error]="isFieldInvalid('trackerDefinitionId')"
              class="form-select"
              formControlName="trackerDefinitionId"
              id="trackerDefinitionId"
            >
              <option value="">-- Select Tracker --</option>
              <option *ngFor="let tracker of trackerDefinitions" [ngValue]="tracker.id">
                {{ tracker.name }}
              </option>
            </select>
            <span *ngIf="isFieldInvalid('trackerDefinitionId')" class="error-text">
              {{ getFieldError('trackerDefinitionId') }}
            </span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Prompt Path *</label>
          <app-directory-browser
            (pathSelected)="onPromptPathSelected($event)"
            [currentPath]="currentPromptPath"
            [disabled]="isSubmitting"
          ></app-directory-browser>
          <span class="help-text">Path to the directory containing agent prompt templates. You can customize your world by adding StoryBible.md and WorldSettings.md files to this directory.</span>
          <span *ngIf="isFieldInvalid('promptPath')" class="error-text">
            {{ getFieldError('promptPath') }}
          </span>
        </div>
      </div>

      <!-- Agent LLM Presets Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">Agent LLM Presets</h2>
          <p class="section-subtitle">Assign LLM presets to each agent</p>
        </div>

        <!-- Apply to all agents -->
        <div class="apply-all-row">
          <label class="form-label" for="applyToAll">Apply to all agents</label>
          <div class="apply-all-controls">
            <select
              (change)="applyPresetToAll($any($event.target).value)"
              class="form-select"
              id="applyToAll"
            >
              <option value="">-- Select preset to apply --</option>
              <option *ngFor="let preset of llmPresets" [value]="preset.id">
                {{ preset.name }}
              </option>
            </select>
            <span class="help-text">Select a preset to assign it to all agents at once</span>
          </div>
        </div>

        <div class="agents-grid" formGroupName="agentPresets">
          <div *ngFor="let agentName of agentNames" class="agent-preset-row">
            <label [for]="'agent-' + agentName" class="agent-label">{{ formatAgentName(agentName) }} *</label>
            <select
              [class.input-error]="isFieldInvalid(agentName, agentPresetsGroup)"
              [formControlName]="agentName"
              [id]="'agent-' + agentName"
              class="form-select agent-select"
            >
              <option value="">-- Select LLM --</option>
              <option *ngFor="let preset of llmPresets" [ngValue]="preset.id">
                {{ preset.name }}
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button
          class="btn btn-secondary"
          routerLink="/"
          type="button"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          </svg>
          Cancel
        </button>

        <button
          [disabled]="isSubmitting"
          class="btn btn-primary"
          type="submit"
        >
          <span *ngIf="!isSubmitting">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="2"></path>
            </svg>
            Create Adventure
          </span>
          <span *ngIf="isSubmitting" class="submit-loading">
            <span class="spinner-small"></span>
            Creating...
          </span>
        </button>
      </div>
    </form>
  </div>
</div>
