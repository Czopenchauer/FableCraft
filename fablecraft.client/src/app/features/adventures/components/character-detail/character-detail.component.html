<div class="character-detail">
  <!-- Header with Name and Importance -->
  <div class="detail-header">
    <h3 class="character-name">{{ character.name }}</h3>

    <div *ngIf="canEditImportance" class="importance-control">
      <label>Importance:</label>
      <select
        (change)="onImportanceChange($event)"
        [value]="pendingImportance || character.importance"
        class="importance-select"
      >
        <option value="arc_important">Arc Important</option>
        <option value="significant">Significant</option>
      </select>

      <div *ngIf="hasImportanceChanges" class="importance-actions">
        <button (click)="saveImportance()" [disabled]="isSavingImportance" class="btn-save-sm">
          <span *ngIf="!isSavingImportance">Save</span>
          <span *ngIf="isSavingImportance">...</span>
        </button>
        <button (click)="discardImportance()" [disabled]="isSavingImportance" class="btn-discard-sm">
          Discard
        </button>
      </div>
    </div>

    <div *ngIf="!canEditImportance" class="importance-label">
      <span class="importance-badge importance-background">
        {{ getImportanceLabel(character.importance) }}
      </span>
    </div>
  </div>

  <!-- Character Info Tabs -->
  <section class="detail-section character-info-section">
    <div class="character-tabs">
      <button
        (click)="setActiveTab('description')"
        [class.active]="activeTab === 'description'"
        class="character-tab-btn"
      >
        Description
      </button>
      <button
        (click)="setActiveTab('state')"
        [class.active]="activeTab === 'state'"
        class="character-tab-btn"
      >
        State
      </button>
      <button
        *ngIf="character.characterTracker"
        (click)="setActiveTab('tracker')"
        [class.active]="activeTab === 'tracker'"
        class="character-tab-btn"
      >
        Tracker
      </button>
      <button
        *ngIf="character.relationships && character.relationships.length > 0"
        (click)="setActiveTab('relationships')"
        [class.active]="activeTab === 'relationships'"
        class="character-tab-btn"
      >
        Relationships ({{ character.relationships.length }})
      </button>
      <button
        (click)="setActiveTab('memories')"
        [class.active]="activeTab === 'memories'"
        class="character-tab-btn"
      >
        Memories ({{ character.characterMemories.length }}/{{ character.totalMemoriesCount }})
      </button>
      <button
        (click)="setActiveTab('rewrites')"
        [class.active]="activeTab === 'rewrites'"
        class="character-tab-btn"
      >
        Rewrites ({{ character.sceneRewrites.length }}/{{ character.totalSceneRewritesCount }})
      </button>
    </div>

    <!-- Description Tab Content -->
    <div *ngIf="activeTab === 'description'" class="tab-content">
      <div class="tab-header">
        <button (click)="editProfile()" class="btn-edit-inline" title="Edit description">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path
              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              stroke-linecap="round"
              stroke-linejoin="round"/>
          </svg>
          Edit
        </button>
      </div>
      <p class="description-text">{{ character.description || 'No description available.' }}</p>
    </div>

    <!-- State Tab Content -->
    <div *ngIf="activeTab === 'state'" class="tab-content">
      <div class="tab-header">
        <button (click)="editProfile()" class="btn-edit-inline" title="Edit state">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path
              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              stroke-linecap="round"
              stroke-linejoin="round"/>
          </svg>
          Edit
        </button>
      </div>
      <div *ngIf="character.characterState" class="json-content-inline">
        <app-json-renderer [data]="character.characterState"></app-json-renderer>
      </div>
      <p *ngIf="!character.characterState" class="empty-state-text">No state data available.</p>
    </div>

    <!-- Tracker Tab Content -->
    <div *ngIf="activeTab === 'tracker'" class="tab-content">
      <div class="tab-header">
        <button (click)="editTracker()" class="btn-edit-inline" title="Edit tracker">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path
              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              stroke-linecap="round"
              stroke-linejoin="round"/>
          </svg>
          Edit
        </button>
      </div>
      <div *ngIf="character.characterTracker" class="json-content-inline">
        <app-json-renderer [data]="character.characterTracker"></app-json-renderer>
      </div>
    </div>

    <!-- Relationships Tab Content -->
    <div *ngIf="activeTab === 'relationships'" class="tab-content">
      <div *ngFor="let rel of character.relationships" class="relationship-item">
        <div class="relationship-header">
          <strong class="relationship-target">{{ rel.targetCharacterName }}</strong>
          <button (click)="editRelationship(rel)" class="btn-edit-sm" title="Edit relationship">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                stroke-linecap="round"
                stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <p *ngIf="rel.dynamic" class="relationship-dynamic">{{ rel.dynamic }}</p>
        <div class="relationship-data">
          <app-json-renderer [data]="rel.data"></app-json-renderer>
        </div>
      </div>
      <p *ngIf="!character.relationships || character.relationships.length === 0" class="empty-state-text">
        No relationships recorded.
      </p>
    </div>

    <!-- Memories Tab Content -->
    <div *ngIf="activeTab === 'memories'" class="tab-content">
      <div *ngIf="character.characterMemories.length > 0" class="memories-list">
        <div *ngFor="let memory of character.characterMemories" class="memory-item">
          <div class="memory-header">
            <span class="memory-salience">Salience: {{ memory.salience | number:'1.1-1' }}</span>
            <button (click)="editMemory(memory)" class="btn-edit-sm" title="Edit memory">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                  stroke-linecap="round"
                  stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          <p class="memory-content">{{ memory.memoryContent }}</p>
          <div *ngIf="memory.sceneTracker" class="memory-context">
            <span class="context-item">{{ memory.sceneTracker.time }}</span>
            <span class="context-item">{{ memory.sceneTracker.location }}</span>
          </div>
        </div>

        <!-- Load More Memories Button -->
        <button
          (click)="loadMoreMemories()"
          *ngIf="hasMoreMemories"
          [disabled]="isLoadingMoreMemories"
          class="btn-load-more"
        >
          <span *ngIf="!isLoadingMoreMemories">
            Load More ({{ character.characterMemories.length }}/{{ character.totalMemoriesCount }})
          </span>
          <span *ngIf="isLoadingMoreMemories">Loading...</span>
        </button>
      </div>
      <p *ngIf="character.characterMemories.length === 0" class="empty-state-text">No memories recorded.</p>
    </div>

    <!-- Scene Rewrites Tab Content -->
    <div *ngIf="activeTab === 'rewrites'" class="tab-content">
      <div *ngIf="character.sceneRewrites.length > 0" class="rewrites-list">
        <div *ngFor="let rewrite of character.sceneRewrites" class="rewrite-item">
          <div class="rewrite-header">
            <span class="rewrite-scene">Scene #{{ rewrite.sequenceNumber }}</span>
            <span *ngIf="rewrite.sceneTracker" class="rewrite-context">
              {{ rewrite.sceneTracker.time }} - {{ rewrite.sceneTracker.location }}
            </span>
          </div>
          <p class="rewrite-content">{{ rewrite.content }}</p>
        </div>

        <!-- Load More Rewrites Button -->
        <button
          (click)="loadMoreRewrites()"
          *ngIf="hasMoreRewrites"
          [disabled]="isLoadingMoreRewrites"
          class="btn-load-more"
        >
          <span *ngIf="!isLoadingMoreRewrites">
            Load More ({{ character.sceneRewrites.length }}/{{ character.totalSceneRewritesCount }})
          </span>
          <span *ngIf="isLoadingMoreRewrites">Loading...</span>
        </button>
      </div>
      <p *ngIf="character.sceneRewrites.length === 0" class="empty-state-text">No scene rewrites available.</p>
    </div>
  </section>
</div>

<!-- JSON Editor Modal -->
<app-json-editor-modal
  (cancel)="onModalCancel()"
  (save)="onModalSave($event)"
  [data]="editModal.data"
  [isOpen]="editModal.isOpen"
  [title]="editModal.title">
</app-json-editor-modal>
