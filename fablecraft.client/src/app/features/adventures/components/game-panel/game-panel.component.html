<div class="game-panel-container">
  <div class="game-panel-content">
    <!-- Header -->
    <div class="game-header">
      <button
        (click)="goToAdventureList()"
        class="back-button"
        title="Back to adventures"
      >
        <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
          <path [attr.d]="'M10 19l-7-7m0 0l7-7m-7 7h18'" [attr.stroke-linecap]="'round'"
                [attr.stroke-linejoin]="'round'"
                [attr.stroke-width]="2"></path>
        </svg>
      </button>
      <h1 class="page-title">{{ adventureName || 'Your Adventure' }}</h1>
      <div *ngIf="currentScene && !isLoading && !isRegenerating" class="action-buttons">
        <!-- Navigation buttons -->
        <button
          (click)="goToPreviousScene()"
          [disabled]="!currentScene.previousScene || isLoading"
          class="btn-action btn-nav"
          title="Previous scene"
        >
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path [attr.d]="'M15 19l-7-7 7-7'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                  [attr.stroke-width]="2"></path>
          </svg>
          <span>Previous</span>
        </button>
        <button
          (click)="goToCurrentScene()"
          [disabled]="isCurrentScene() || isLoading"
          class="btn-action btn-nav btn-current"
          title="Jump to current scene"
        >
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path [attr.d]="'M13 5l7 7-7 7M5 5l7 7-7 7'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                  [attr.stroke-width]="2"></path>
          </svg>
          <span>Current</span>
        </button>
        <button
          (click)="goToNextScene()"
          [disabled]="!currentScene.nextScene || isLoading"
          class="btn-action btn-nav"
          title="Next scene"
        >
          <span>Next</span>
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path [attr.d]="'M9 5l7 7-7 7'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                  [attr.stroke-width]="2"></path>
          </svg>
        </button>

        <!-- Action buttons -->
        <button
          (click)="onRegenerateScene()"
          class="btn-action btn-regenerate"
          title="Regenerate this scene"
        >
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path
              [attr.d]="'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15'"
              [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
              [attr.stroke-width]="2"></path>
          </svg>
          <span>Regenerate</span>
        </button>
        <button
          (click)="onDeleteLastScene()"
          class="btn-action btn-delete"
          title="Delete this scene"
        >
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path
              [attr.d]="'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16'"
              [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
              [attr.stroke-width]="2"></path>
          </svg>
          <span>Delete</span>
        </button>
        <button
          (click)="openSettingsModal()"
          class="btn-action btn-settings"
          title="Adventure settings"
        >
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path
              [attr.d]="'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z'"
              [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
              [attr.stroke-width]="2"></path>
            <path
              [attr.d]="'M15 12a3 3 0 11-6 0 3 3 0 016 0z'"
              [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
              [attr.stroke-width]="2"></path>
          </svg>
          <span>Settings</span>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading && isInitialLoad" class="loading-state">
      <div class="loading-content">
        <svg [attr.fill]="'none'" class="spinner" viewBox="0 0 24 24">
          <circle [attr.cx]="12" [attr.cy]="12" [attr.r]="10" [attr.stroke-width]="4" [attr.stroke]="'currentColor'"
                  class="opacity-25"></circle>
          <path
            [attr.d]="'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'"
            [attr.fill]="'currentColor'"
            class="opacity-75"></path>
        </svg>
        <p class="loading-text">Loading your adventure...</p>
      </div>
    </div>

    <!-- Story Tracker (above scene) - Story and Characters Present only -->
    <div *ngIf="currentScene && !isInitialLoad && currentScene.tracker" class="story-tracker-panel" [class.regenerating]="isRegenerating" [class.regenerating-enrichment]="isRegeneratingEnrichment">
      <div *ngIf="currentScene.tracker.story" class="story-tracker-section">
        <app-json-renderer [data]="{story: currentScene.tracker.story}"></app-json-renderer>
      </div>
      <div *ngIf="currentScene.tracker.charactersOnScene" class="story-tracker-section">
        <app-json-renderer [data]="{charactersOnScene: currentScene.tracker.charactersOnScene}"></app-json-renderer>
      </div>
    </div>

    <!-- Game Content -->
    <div *ngIf="currentScene && !isInitialLoad" [class.regenerating]="isRegenerating" class="game-content">
      <!-- Regenerating overlay -->
      <div *ngIf="isRegenerating" class="regenerating-overlay">
        <svg [attr.fill]="'none'" class="spinner-small" viewBox="0 0 24 24">
          <circle [attr.cx]="12" [attr.cy]="12" [attr.r]="10" [attr.stroke-width]="4" [attr.stroke]="'currentColor'"
                  class="opacity-25"></circle>
          <path
            [attr.d]="'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'"
            [attr.fill]="'currentColor'"
            class="opacity-75"></path>
        </svg>
        <p class="regenerating-text">Regenerating scene...</p>
      </div>

      <!-- Columns: left character tracker, right main content -->
      <div class="game-columns">
        <!-- Character Tracker panel (Protagonist and Characters) -->
        <div class="tracker-panel" [class.regenerating-enrichment]="isRegeneratingEnrichment">
          <!-- Regenerating enrichment overlay -->
          <div *ngIf="isRegeneratingEnrichment" class="regenerating-enrichment-overlay">
            <svg [attr.fill]="'none'" class="spinner-small" viewBox="0 0 24 24">
              <circle [attr.cx]="12" [attr.cy]="12" [attr.r]="10" [attr.stroke-width]="4" [attr.stroke]="'currentColor'"
                      class="opacity-25"></circle>
              <path
                [attr.d]="'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'"
                [attr.fill]="'currentColor'"
                class="opacity-75"></path>
            </svg>
            <p class="regenerating-text">Regenerating tracker...</p>
          </div>

          <div class="tracker-header">
            Characters
            <span *ngIf="isEnriching" class="enriching-badge">Loading...</span>
            <span *ngIf="enrichmentFailed" class="enrichment-failed-badge">Failed</span>
            <!-- Regenerate enrichment dropdown -->
            <div *ngIf="canRegenerateEnrichment()" class="regenerate-dropdown-container">
              <button
                (click)="toggleRegenerateDropdown()"
                class="btn-regenerate-enrichment"
                [class.active]="showRegenerateDropdown"
                title="Regenerate tracker data"
              >
                <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
                  <path
                    [attr.d]="'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15'"
                    [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                    [attr.stroke-width]="2"></path>
                </svg>
              </button>
              <!-- Dropdown menu -->
              <div *ngIf="showRegenerateDropdown" class="regenerate-dropdown-menu">
                <div class="dropdown-header">
                  <span>Select agents to regenerate</span>
                  <button (click)="closeRegenerateDropdown()" class="dropdown-close" title="Close">
                    <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
                      <path [attr.d]="'M6 18L18 6M6 6l12 12'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'" [attr.stroke-width]="2"></path>
                    </svg>
                  </button>
                </div>
                <div class="dropdown-options">
                  <label *ngFor="let agent of availableAgents" class="dropdown-option">
                    <input
                      type="checkbox"
                      [checked]="isAgentSelected(agent.id)"
                      (change)="toggleAgentSelection(agent.id)"
                    />
                    <div class="option-content">
                      <span class="option-label">{{ agent.label }}</span>
                      <span class="option-description">{{ agent.description }}</span>
                    </div>
                  </label>
                </div>
                <div class="dropdown-actions">
                  <button (click)="selectAllAgents()" class="btn-dropdown-action" type="button">All</button>
                  <button (click)="deselectAllAgents()" class="btn-dropdown-action" type="button">None</button>
                  <button
                    (click)="regenerateSelectedAgents()"
                    class="btn-dropdown-regenerate"
                    [disabled]="selectedAgents.size === 0"
                    type="button"
                  >
                    Regenerate
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Loading state -->
          <div *ngIf="isEnriching" class="tracker-loading">
            <svg [attr.fill]="'none'" class="spinner-small" viewBox="0 0 24 24">
              <circle [attr.cx]="12" [attr.cy]="12" [attr.r]="10" [attr.stroke-width]="4" [attr.stroke]="'currentColor'"
                      class="opacity-25"></circle>
              <path
                [attr.d]="'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'"
                [attr.fill]="'currentColor'"
                class="opacity-75"></path>
            </svg>
            <p style="margin-top: 8px; font-size: 0.875rem; color: #6b7280;">Loading tracker data...</p>
          </div>

          <!-- Retry enrichment button when failed -->
          <div *ngIf="enrichmentFailed && !isEnriching" class="enrichment-retry">
            <p class="enrichment-retry-message">Enrichment failed to load tracker data.</p>
            <button
              (click)="retryEnrichment()"
              class="btn-retry-enrichment"
              title="Retry enrichment"
            >
              <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
                <path
                  [attr.d]="'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15'"
                  [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                  [attr.stroke-width]="2"></path>
              </svg>
              <span>Retry Enrichment</span>
            </button>
          </div>

          <!-- Character Tabs -->
          <div *ngIf="!isEnriching && !enrichmentFailed && currentScene.tracker" class="character-tabs">
            <!-- Tab Headers -->
            <div class="character-tabs-header">
              <!-- Protagonist Tab -->
              <button
                (click)="setActiveCharacterTab('protagonist')"
                [class.active]="isActiveCharacterTab('protagonist')"
                class="character-tab-btn"
                type="button"
              >
                Protagonist
              </button>
              <!-- Character Tabs (one per character in tracker.characters) -->
              <button
                (click)="setActiveCharacterTab(char.name)"
                *ngFor="let char of currentScene.tracker.characters"
                [class.active]="isActiveCharacterTab(char.name)"
                class="character-tab-btn"
                type="button"
              >
                {{ char.name }}
              </button>
            </div>

            <!-- Tab Content -->
            <div class="character-tabs-content">
              <!-- Protagonist Content -->
              <div *ngIf="isActiveCharacterTab('protagonist') && currentScene.tracker.mainCharacter" class="character-tab-panel">
                <!-- Nested tabs for protagonist -->
                <div class="nested-tabs-header">
                  <button
                    (click)="setActiveNestedTab('state')"
                    [class.active]="isActiveNestedTab('state')"
                    class="nested-tab-btn"
                    type="button"
                  >
                    State
                  </button>
                  <button
                    (click)="setActiveNestedTab('development')"
                    [class.active]="isActiveNestedTab('development')"
                    class="nested-tab-btn"
                    type="button"
                  >
                    Development
                  </button>
                  <button
                    (click)="setActiveNestedTab('description')"
                    [class.active]="isActiveNestedTab('description')"
                    class="nested-tab-btn"
                    type="button"
                  >
                    Description
                  </button>
                </div>
                <div class="nested-tabs-content">
                  <div *ngIf="isActiveNestedTab('state')" class="nested-tab-panel">
                    <app-json-renderer [data]="currentScene.tracker.mainCharacter.tracker"></app-json-renderer>
                  </div>
                  <div *ngIf="isActiveNestedTab('development')" class="nested-tab-panel">
                    <app-json-renderer [data]="currentScene.tracker.mainCharacter.development"></app-json-renderer>
                  </div>
                  <div *ngIf="isActiveNestedTab('description')" class="nested-tab-panel">
                    <app-json-renderer [data]="{description: currentScene.tracker.mainCharacter.description}"></app-json-renderer>
                  </div>
                </div>
              </div>

              <!-- Character Content (for each character in tracker.characters) -->
              <ng-container *ngFor="let character of currentScene.tracker.characters">
                <div *ngIf="isActiveCharacterTab(character.name)" class="character-tab-panel">
                  <!-- Nested tabs for character -->
                  <div class="nested-tabs-header">
                    <button
                      (click)="setActiveNestedTab('state')"
                      [class.active]="isActiveNestedTab('state')"
                      class="nested-tab-btn"
                      type="button"
                    >
                      State
                    </button>
                    <button
                      (click)="setActiveNestedTab('development')"
                      [class.active]="isActiveNestedTab('development')"
                      class="nested-tab-btn"
                      type="button"
                    >
                      Development
                    </button>
                    <button
                      (click)="setActiveNestedTab('description')"
                      [class.active]="isActiveNestedTab('description')"
                      class="nested-tab-btn"
                      type="button"
                    >
                      Description
                    </button>
                  </div>
                  <div class="nested-tabs-content">
                    <div *ngIf="isActiveNestedTab('state')" class="nested-tab-panel">
                      <app-json-renderer [data]="character.tracker"></app-json-renderer>
                    </div>
                    <div *ngIf="isActiveNestedTab('development')" class="nested-tab-panel">
                      <app-json-renderer [data]="character.development"></app-json-renderer>
                    </div>
                    <div *ngIf="isActiveNestedTab('description')" class="nested-tab-panel">
                      <app-json-renderer [data]="{description: character.description}"></app-json-renderer>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
          </div>

          <!-- Display lore data (from enrichment or loaded scene) -->
          <div *ngIf="!isEnriching && (enrichmentData?.newLore?.length || currentScene.newLore?.length)" class="enrichment-info">
            <div class="enrichment-section">
              <h4>New Lore:</h4>
              <div *ngFor="let lore of (enrichmentData?.newLore || currentScene.newLore)" class="enrichment-item">
                <strong>{{ lore.title }}</strong>: {{ lore.summary }}
              </div>
            </div>
          </div>
        </div>

        <!-- Main content -->
        <div class="game-main">
          <!-- Scene Narrative -->
          <div class="scene-container">
            <div class="scene-narrative">
              <p class="narrative-text">{{ currentScene.text }}</p>
            </div>
          </div>

          <!-- Submitted Action (what led to this scene) -->
          <div *ngIf="currentScene.selectedChoice" class="submitted-action-container">
            <h2 class="submitted-action-title">Your action:</h2>
            <div class="submitted-action-item">
              <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" class="choice-arrow" viewBox="0 0 24 24">
                <path [attr.d]="'M13 7l5 5m0 0l-5 5m5-5H6'" [attr.stroke-linecap]="'round'"
                      [attr.stroke-linejoin]="'round'"
                      [attr.stroke-width]="2"></path>
              </svg>
              <div class="choice-text">{{ currentScene.selectedChoice }}</div>
            </div>
          </div>

          <!-- Choices -->
          <div class="choices-container">
            <!-- Title for current scene -->
            <h2 *ngIf="isCurrentScene()" class="choices-title">What do you do?</h2>

            <!-- Title for historical scene -->
            <h2 *ngIf="!isCurrentScene()" class="choices-title">Available choices were:</h2>

            <!-- Blocked message for current scene when tracker is missing (but not during enrichment) -->
            <div *ngIf="isCurrentScene() && !isEnriching && !currentScene.tracker && enrichmentFailed" class="choices-blocked-message">
              <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" class="blocked-icon" viewBox="0 0 24 24">
                <path [attr.d]="'M12 15v2m0 0v2m0-2h2m-2 0H10m4-6V7a2 2 0 10-4 0v4m-4 4h12a2 2 0 002-2v-4a2 2 0 00-2-2H6a2 2 0 00-2 2v4a2 2 0 002 2z'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'" [attr.stroke-width]="2"></path>
              </svg>
              <p class="blocked-text">
                Tracker data required. Please retry enrichment.
              </p>
            </div>

            <div class="choices-card">
              <!-- First 3 predefined choices -->
              <div
                (click)="isCurrentScene() && !(isRegenerating || isLoading || isEnriching || isActionBlocked()) && onChoiceSelected(choice)"
                *ngFor="let choice of currentScene.choices?.slice(0, 3)"
                [class.disabled]="!isCurrentScene() || (isCurrentScene() && (isLoading || isEnriching))"
                [class.interactive]="isCurrentScene() && !isRegenerating && !isLoading && !isEnriching && !isActionBlocked()"
                class="choice-item"
              >
                <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" class="choice-arrow" viewBox="0 0 24 24">
                  <path [attr.d]="'M13 7l5 5m0 0l-5 5m5-5H6'" [attr.stroke-linecap]="'round'"
                        [attr.stroke-linejoin]="'round'"
                        [attr.stroke-width]="2"></path>
                </svg>
                <div class="choice-text">{{ choice }}</div>
              </div>

              <!-- Custom action - show as input for current scene, or as selected choice for historical scene -->
              <div *ngIf="isCurrentScene()"
                   [class.disabled]="isRegenerating || isLoading || isEnriching || isActionBlocked()"
                   class="choice-item choice-item-custom choice-item-last">
                <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" class="choice-arrow" viewBox="0 0 24 24">
                  <path [attr.d]="'M13 7l5 5m0 0l-5 5m5-5H6'" [attr.stroke-linecap]="'round'"
                        [attr.stroke-linejoin]="'round'"
                        [attr.stroke-width]="2"></path>
                </svg>
                <textarea
                  (keydown)="onCustomActionKeyDown($event)"
                  [(ngModel)]="customAction"
                  [disabled]="isLoading || isRegenerating || isEnriching || isActionBlocked()"
                  class="custom-action-input"
                  placeholder="Or type your own action..."
                  rows="1"
                ></textarea>
                <button
                  (click)="onCustomActionSubmit()"
                  *ngIf="customAction.trim()"
                  [disabled]="isLoading || isRegenerating || isEnriching || isActionBlocked()"
                  class="custom-action-submit"
                  title="Submit custom action"
                >
                  <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
                    <path [attr.d]="'M9 5l7 7-7 7'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                          [attr.stroke-width]="2"></path>
                  </svg>
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Adventure Settings Modal -->
  <app-adventure-settings-modal
    (close)="closeSettingsModal()"
    (saved)="onSettingsSaved()"
    [adventureId]="adventureId"
    [isOpen]="showSettingsModal">
  </app-adventure-settings-modal>
</div>
