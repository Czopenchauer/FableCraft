<div class="tracker-definition-builder">
  <div class="header">
    <h2>{{ isEditMode ? 'Edit Tracker Definition' : 'Create Tracker Definition' }}</h2>
  </div>

  <div *ngIf="isLoading" class="loading">Loading...</div>

  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div *ngIf="!isLoading && structure" class="builder-form">
    <!-- Name Section -->
    <div class="form-section">
      <label class="form-label">Definition Name *</label>
      <input
        type="text"
        [(ngModel)]="definitionName"
        class="form-input"
        placeholder="Enter tracker definition name"
      />
    </div>

    <!-- Story Section -->
    <div class="structure-section">
      <h3 class="section-title">Story Fields</h3>
      <div class="fields-container">
        <div *ngFor="let field of structure.story; let i = index; trackBy: trackByIndex" class="field-card"
             [class.framework-field]="isFrameworkField('story', field.name)">
          <div class="field-header">
            <span class="field-name">
              <span *ngIf="isFrameworkField('story', field.name)" class="lock-icon" title="Framework field - Name and Type locked">ðŸ”’</span>
              {{ field.name }}
            </span>
            <button
              *ngIf="!isFrameworkField('story', field.name)"
              class="btn-remove"
              (click)="removeField('story', i)"
              title="Remove field"
            >
              Remove
            </button>
          </div>

          <div class="field-body">
            <div class="field-row">
              <label>Field Name</label>
              <input
                type="text"
                [(ngModel)]="field.name"
                [disabled]="isFrameworkField('story', field.name)"
                class="field-input"
              />
            </div>

            <div class="field-row">
              <label>Type</label>
              <select
                [(ngModel)]="field.type"
                [disabled]="isFrameworkField('story', field.name)"
                class="field-select"
              >
                <option [value]="FieldType.String">String</option>
                <option [value]="FieldType.Array">Array</option>
                <option [value]="FieldType.Object">Object</option>
                <option [value]="FieldType.ForEachObject">ForEachObject</option>
              </select>
            </div>

            <div class="field-row">
              <label>Prompt</label>
              <textarea
                [(ngModel)]="field.prompt"
                class="field-textarea"
                rows="3"
              ></textarea>
            </div>

            <div class="field-row">
              <label>Default Value</label>
              <input
                type="text"
                [(ngModel)]="field.defaultValue"
                class="field-input"
              />
            </div>

            <div class="field-row">
              <label>Example Values</label>
              <div class="example-values">
                <div *ngFor="let example of field.exampleValues; let j = index" class="example-value-row">
                  <input
                    type="text"
                    [(ngModel)]="field.exampleValues![j]"
                    class="field-input"
                  />
                  <button class="btn-remove-small" (click)="removeExampleValue(field, j)">Ã—</button>
                </div>
                <button class="btn-add-small" (click)="addExampleValue(field)">+ Add Example</button>
              </div>
            </div>

            <div *ngIf="field.type === FieldType.Object || field.type === FieldType.ForEachObject" class="nested-fields">
              <label>Nested Fields</label>
              <div *ngFor="let nested of field.nestedFields; let k = index" class="nested-field-item">
                <span>{{ nested.name }} ({{ nested.type }})</span>
                <button class="btn-remove-small" (click)="removeNestedField(field, k)">Remove</button>
              </div>
              <button class="btn-add-small" (click)="addNestedField(field)">+ Add Nested Field</button>
            </div>
          </div>
        </div>

        <button class="btn-add-field" (click)="addCustomField('story')">+ Add Custom Field to Story</button>
      </div>
    </div>

    <!-- CharactersPresent Section -->
    <div class="structure-section">
      <h3 class="section-title">Characters Present Field</h3>
      <div class="field-card framework-field">
        <div class="field-header">
          <span class="field-name">
            <span class="lock-icon" title="Framework field - Name and Type locked">ðŸ”’</span>
            {{ structure.charactersPresent.name }}
          </span>
        </div>

        <div class="field-body">
          <div class="field-row">
            <label>Field Name</label>
            <input
              type="text"
              [(ngModel)]="structure.charactersPresent.name"
              disabled
              class="field-input"
            />
          </div>

          <div class="field-row">
            <label>Type</label>
            <select
              [(ngModel)]="structure.charactersPresent.type"
              disabled
              class="field-select"
            >
              <option [value]="FieldType.Array">Array</option>
            </select>
          </div>

          <div class="field-row">
            <label>Prompt</label>
            <textarea
              [(ngModel)]="structure.charactersPresent.prompt"
              class="field-textarea"
              rows="3"
            ></textarea>
          </div>

          <div class="field-row">
            <label>Default Value</label>
            <input
              type="text"
              [(ngModel)]="structure.charactersPresent.defaultValue"
              class="field-input"
            />
          </div>

          <div class="field-row">
            <label>Example Values</label>
            <div class="example-values">
              <div *ngFor="let example of structure.charactersPresent.exampleValues; let j = index" class="example-value-row">
                <input
                  type="text"
                  [(ngModel)]="structure.charactersPresent.exampleValues![j]"
                  class="field-input"
                />
                <button class="btn-remove-small" (click)="removeExampleValue(structure.charactersPresent, j)">Ã—</button>
              </div>
              <button class="btn-add-small" (click)="addExampleValue(structure.charactersPresent)">+ Add Example</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MainCharacter Section -->
    <div class="structure-section">
      <h3 class="section-title">Main Character Fields</h3>
      <div class="fields-container">
        <div *ngFor="let field of structure.mainCharacter; let i = index; trackBy: trackByIndex" class="field-card"
             [class.framework-field]="isFrameworkField('mainCharacter', field.name)">
          <div class="field-header">
            <span class="field-name">
              <span *ngIf="isFrameworkField('mainCharacter', field.name)" class="lock-icon" title="Framework field - Name and Type locked">ðŸ”’</span>
              {{ field.name }}
            </span>
            <button
              *ngIf="!isFrameworkField('mainCharacter', field.name)"
              class="btn-remove"
              (click)="removeField('mainCharacter', i)"
              title="Remove field"
            >
              Remove
            </button>
          </div>

          <div class="field-body">
            <div class="field-row">
              <label>Field Name</label>
              <input
                type="text"
                [(ngModel)]="field.name"
                [disabled]="isFrameworkField('mainCharacter', field.name)"
                class="field-input"
              />
            </div>

            <div class="field-row">
              <label>Type</label>
              <select
                [(ngModel)]="field.type"
                [disabled]="isFrameworkField('mainCharacter', field.name)"
                class="field-select"
              >
                <option [value]="FieldType.String">String</option>
                <option [value]="FieldType.Array">Array</option>
                <option [value]="FieldType.Object">Object</option>
                <option [value]="FieldType.ForEachObject">ForEachObject</option>
              </select>
            </div>

            <div class="field-row">
              <label>Prompt</label>
              <textarea
                [(ngModel)]="field.prompt"
                class="field-textarea"
                rows="3"
              ></textarea>
            </div>

            <div class="field-row">
              <label>Default Value</label>
              <input
                type="text"
                [(ngModel)]="field.defaultValue"
                class="field-input"
              />
            </div>

            <div class="field-row">
              <label>Example Values</label>
              <div class="example-values">
                <div *ngFor="let example of field.exampleValues; let j = index" class="example-value-row">
                  <input
                    type="text"
                    [(ngModel)]="field.exampleValues![j]"
                    class="field-input"
                  />
                  <button class="btn-remove-small" (click)="removeExampleValue(field, j)">Ã—</button>
                </div>
                <button class="btn-add-small" (click)="addExampleValue(field)">+ Add Example</button>
              </div>
            </div>
          </div>
        </div>

        <button class="btn-add-field" (click)="addCustomField('mainCharacter')">+ Add Custom Field to Main Character</button>
      </div>
    </div>

    <!-- Characters Section -->
    <div class="structure-section">
      <h3 class="section-title">Character Fields</h3>
      <div class="fields-container">
        <div *ngFor="let field of structure.characters; let i = index; trackBy: trackByIndex" class="field-card"
             [class.framework-field]="isFrameworkField('characters', field.name)">
          <div class="field-header">
            <span class="field-name">
              <span *ngIf="isFrameworkField('characters', field.name)" class="lock-icon" title="Framework field - Name and Type locked">ðŸ”’</span>
              {{ field.name }}
            </span>
            <button
              *ngIf="!isFrameworkField('characters', field.name)"
              class="btn-remove"
              (click)="removeField('characters', i)"
              title="Remove field"
            >
              Remove
            </button>
          </div>

          <div class="field-body">
            <div class="field-row">
              <label>Field Name</label>
              <input
                type="text"
                [(ngModel)]="field.name"
                [disabled]="isFrameworkField('characters', field.name)"
                class="field-input"
              />
            </div>

            <div class="field-row">
              <label>Type</label>
              <select
                [(ngModel)]="field.type"
                [disabled]="isFrameworkField('characters', field.name)"
                class="field-select"
              >
                <option [value]="FieldType.String">String</option>
                <option [value]="FieldType.Array">Array</option>
                <option [value]="FieldType.Object">Object</option>
                <option [value]="FieldType.ForEachObject">ForEachObject</option>
              </select>
            </div>

            <div class="field-row">
              <label>Prompt</label>
              <textarea
                [(ngModel)]="field.prompt"
                class="field-textarea"
                rows="3"
              ></textarea>
            </div>

            <div class="field-row">
              <label>Default Value</label>
              <input
                type="text"
                [(ngModel)]="field.defaultValue"
                class="field-input"
              />
            </div>

            <div class="field-row">
              <label>Example Values</label>
              <div class="example-values">
                <div *ngFor="let example of field.exampleValues; let j = index" class="example-value-row">
                  <input
                    type="text"
                    [(ngModel)]="field.exampleValues![j]"
                    class="field-input"
                  />
                  <button class="btn-remove-small" (click)="removeExampleValue(field, j)">Ã—</button>
                </div>
                <button class="btn-add-small" (click)="addExampleValue(field)">+ Add Example</button>
              </div>
            </div>
          </div>
        </div>

        <button class="btn-add-field" (click)="addCustomField('characters')">+ Add Custom Field to Characters</button>
      </div>
    </div>

    <!-- Optional Sections -->
    <div class="structure-section">
      <h3 class="section-title">Optional Sections</h3>

      <div class="optional-section">
        <div class="optional-header">
          <span>Character Development</span>
          <button
            *ngIf="!structure.characterDevelopment"
            class="btn-enable"
            (click)="enableCharacterDevelopment()"
          >
            Enable
          </button>
          <button
            *ngIf="structure.characterDevelopment"
            class="btn-disable"
            (click)="disableCharacterDevelopment()"
          >
            Disable
          </button>
        </div>

        <div *ngIf="structure.characterDevelopment" class="fields-container">
          <div *ngFor="let field of structure.characterDevelopment; let i = index; trackBy: trackByIndex" class="field-card">
            <div class="field-header">
              <span class="field-name">{{ field.name }}</span>
              <button class="btn-remove" (click)="removeField('characterDevelopment', i)">Remove</button>
            </div>
            <div class="field-body">
              <div class="field-row">
                <label>Field Name</label>
                <input type="text" [(ngModel)]="field.name" class="field-input" />
              </div>
              <div class="field-row">
                <label>Type</label>
                <select [(ngModel)]="field.type" class="field-select">
                  <option [value]="FieldType.String">String</option>
                  <option [value]="FieldType.Array">Array</option>
                  <option [value]="FieldType.Object">Object</option>
                  <option [value]="FieldType.ForEachObject">ForEachObject</option>
                </select>
              </div>
              <div class="field-row">
                <label>Prompt</label>
                <textarea [(ngModel)]="field.prompt" class="field-textarea" rows="3"></textarea>
              </div>
            </div>
          </div>
          <button class="btn-add-field" (click)="addCustomField('characterDevelopment')">+ Add Field</button>
        </div>
      </div>

      <div class="optional-section">
        <div class="optional-header">
          <span>Main Character Development</span>
          <button
            *ngIf="!structure.mainCharacterDevelopment"
            class="btn-enable"
            (click)="enableMainCharacterDevelopment()"
          >
            Enable
          </button>
          <button
            *ngIf="structure.mainCharacterDevelopment"
            class="btn-disable"
            (click)="disableMainCharacterDevelopment()"
          >
            Disable
          </button>
        </div>

        <div *ngIf="structure.mainCharacterDevelopment" class="fields-container">
          <div *ngFor="let field of structure.mainCharacterDevelopment; let i = index; trackBy: trackByIndex" class="field-card">
            <div class="field-header">
              <span class="field-name">{{ field.name }}</span>
              <button class="btn-remove" (click)="removeField('mainCharacterDevelopment', i)">Remove</button>
            </div>
            <div class="field-body">
              <div class="field-row">
                <label>Field Name</label>
                <input type="text" [(ngModel)]="field.name" class="field-input" />
              </div>
              <div class="field-row">
                <label>Type</label>
                <select [(ngModel)]="field.type" class="field-select">
                  <option [value]="FieldType.String">String</option>
                  <option [value]="FieldType.Array">Array</option>
                  <option [value]="FieldType.Object">Object</option>
                  <option [value]="FieldType.ForEachObject">ForEachObject</option>
                </select>
              </div>
              <div class="field-row">
                <label>Prompt</label>
                <textarea [(ngModel)]="field.prompt" class="field-textarea" rows="3"></textarea>
              </div>
            </div>
          </div>
          <button class="btn-add-field" (click)="addCustomField('mainCharacterDevelopment')">+ Add Field</button>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn-save" (click)="onSave()" [disabled]="isSaving">
        {{ isSaving ? 'Saving...' : 'Save' }}
      </button>
      <button class="btn-cancel" (click)="onCancel()">Cancel</button>
      <button *ngIf="isEditMode" class="btn-delete" (click)="onDelete()">Delete</button>
    </div>
  </div>
</div>
