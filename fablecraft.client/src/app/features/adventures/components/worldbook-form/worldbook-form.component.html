<div class="form-container">
  <div class="form-content">
    <!-- Header -->
    <div class="form-header">
      <div class="header-left">
        <button (click)="cancel()" class="back-button">
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path [attr.d]="'M10 19l-7-7m0 0l7-7m-7 7h18'" [attr.stroke-linecap]="'round'"
                  [attr.stroke-linejoin]="'round'" [attr.stroke-width]="2"></path>
          </svg>
        </button>
        <h1 class="page-title">{{ isEditMode ? 'Edit Worldbook' : 'Create Worldbook' }}</h1>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="loading-content">
        <svg [attr.fill]="'none'" class="spinner" viewBox="0 0 24 24">
          <circle [attr.cx]="12" [attr.cy]="12" [attr.r]="10" [attr.stroke-width]="4" [attr.stroke]="'currentColor'"
                  class="opacity-25"></circle>
          <path
            [attr.d]="'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'"
            [attr.fill]="'currentColor'" class="opacity-75"></path>
        </svg>
        <p class="loading-text">Loading worldbook...</p>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-state">
      <div class="error-content">
        <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" class="error-icon" viewBox="0 0 24 24">
          <path [attr.d]="'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'" [attr.stroke-linecap]="'round'"
                [attr.stroke-linejoin]="'round'" [attr.stroke-width]="2"></path>
        </svg>
        <div class="error-text">
          <h3 class="error-title">Error</h3>
          <p class="error-message">{{ error }}</p>
        </div>
      </div>
    </div>

    <!-- Pending Changes Banner -->
    <div *ngIf="indexingStatus === 'NeedsReindexing'" class="pending-changes-banner">
      <div class="banner-content">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="banner-icon">
          <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="banner-text">
          <strong>Pending Changes</strong>
          <span>This worldbook has changes that need to be re-indexed to take effect.</span>
        </div>
        <button (click)="revertAllChanges()" [disabled]="reverting" class="btn-revert-all" type="button">
          <svg *ngIf="!reverting" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          {{ reverting ? 'Reverting...' : 'Revert All Changes' }}
        </button>
      </div>
    </div>

    <!-- Deleted Lorebooks Section -->
    <div *ngIf="getDeletedLorebooks().length > 0" class="deleted-lorebooks-section">
      <h3 class="deleted-section-title">Deleted Lorebooks (pending removal)</h3>
      <div class="deleted-lorebooks-list">
        <div *ngFor="let lorebook of getDeletedLorebooks()" class="deleted-lorebook-item">
          <span class="deleted-lorebook-title">{{ lorebook.title }}</span>
          <span class="deleted-lorebook-category">{{ lorebook.category }}</span>
          <button (click)="restoreDeletedLorebook(lorebook)" class="btn-restore" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Restore
          </button>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form (ngSubmit)="onSubmit()" *ngIf="!loading" [formGroup]="worldbookForm" class="worldbook-form">
      <div class="form-card">
        <!-- Name Field -->
        <div class="form-group">
          <label class="form-label" for="name">
            Worldbook Name
            <span class="required">*</span>
          </label>
          <input
            [class.error]="nameControl?.invalid && nameControl?.touched"
            class="form-input"
            formControlName="name"
            id="name"
            placeholder="Enter worldbook name"
            type="text"
          />
          <div *ngIf="nameControl?.invalid && nameControl?.touched" class="field-error">
            <span *ngIf="nameControl?.errors?.['required']">Worldbook name is required</span>
            <span *ngIf="nameControl?.errors?.['maxlength']">Worldbook name must not exceed 200 characters</span>
          </div>
        </div>

        <!-- GraphRAG Settings Field -->
        <div class="form-group">
          <label class="form-label" for="graphRagSettingsId">
            GraphRAG Settings
          </label>
          <select
            class="form-input"
            formControlName="graphRagSettingsId"
            id="graphRagSettingsId"
          >
            <option [ngValue]="null">-- None --</option>
            <option *ngFor="let settings of graphRagSettingsOptions" [ngValue]="settings.id">
              {{ settings.name }}
            </option>
          </select>
          <div class="field-help">Optional. Select GraphRAG settings for knowledge graph indexing.</div>
        </div>

        <!-- Lorebooks Section -->
        <div class="lorebooks-section">
          <div class="section-header">
            <h3 class="section-title">Lorebooks</h3>
            <div class="section-actions">
              <button (click)="triggerFileInput()" [disabled]="saving" class="btn-import-json"
                      title="Import lorebooks from JSON"
                      type="button">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2"/>
                </svg>
                Import JSON
              </button>
              <button (click)="addLorebook()" [disabled]="saving" class="btn-add-lorebook" type="button">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                </svg>
                Add Lorebook
              </button>
            </div>
          </div>

          <!-- Hidden file input for JSON import -->
          <input
            (change)="onFileSelected($event)"
            accept=".json"
            id="json-file-input"
            style="display: none;"
            type="file"
          />

          <!-- Import Error Message -->
          <div *ngIf="importError" class="import-error">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="2"/>
            </svg>
            <span>{{ importError }}</span>
            <button (click)="importError = null" class="btn-close-error" type="button">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
              </svg>
            </button>
          </div>

          <!-- Empty State -->
          <div *ngIf="lorebooks.length === 0" class="lorebooks-empty">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
                stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
            </svg>
            <p>No lorebooks yet. Click "Add Lorebook" to get started.</p>
          </div>

          <!-- Lorebook Panels -->
          <div formArrayName="lorebooks">
            <div *ngFor="let lorebookCtrl of lorebooks.controls; let i = index; trackBy: trackByIndex"
                 [formGroupName]="i"
                 class="lorebook-panel">

              <!-- Panel Header (clickable) -->
              <div (click)="togglePanel(i)"
                   (keydown)="onKeyDown($event, i)"
                   [attr.aria-expanded]="isPanelExpanded(i)"
                   [attr.aria-label]="'Toggle ' + getLorebookTitle(i) + ' panel'"
                   [class.expanded]="isPanelExpanded(i)"
                   [class.has-errors]="hasLorebookErrors(i)"
                   [class.is-added]="isLorebookAdded(i)"
                   [class.is-modified]="isLorebookModified(i)"
                   class="lorebook-panel-header"
                   role="button"
                   tabindex="0">

                <!-- Chevron icon (rotates when expanded) -->
                <svg [class.expanded]="isPanelExpanded(i)" class="chevron-icon" fill="none" stroke="currentColor"
                     viewBox="0 0 24 24">
                  <path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                </svg>

                <!-- Title -->
                <span
                  [class.placeholder]="!lorebookCtrl.get('title')?.value || lorebookCtrl.get('title')?.value === '' || getLorebookTitle(i) === 'New Lorebook'"
                  class="panel-title">
                  {{ getLorebookTitle(i) }}
                </span>

                <!-- Change status badge -->
                <span *ngIf="isLorebookAdded(i)" class="change-badge added">Added</span>
                <span *ngIf="isLorebookModified(i)" class="change-badge modified">Modified</span>

                <!-- Category badge (if category exists) -->
                <span *ngIf="getLorebookCategory(i)" class="category-badge">
                  {{ getLorebookCategory(i) }}
                </span>

                <!-- Revert button (for modified lorebooks) -->
                <button *ngIf="isLorebookModified(i)"
                        (click)="revertLorebook(i); $event.stopPropagation()"
                        [attr.aria-label]="'Revert ' + getLorebookTitle(i)"
                        class="btn-revert-lorebook"
                        title="Revert to indexed state"
                        type="button">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>

                <!-- Delete button -->
                <button (click)="deleteLorebook(i); $event.stopPropagation()"
                        [attr.aria-label]="'Delete ' + getLorebookTitle(i)"
                        class="btn-delete-lorebook"
                        title="Delete lorebook"
                        type="button">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                      stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                  </svg>
                </button>
              </div>

              <!-- Panel Content (shown when expanded) -->
              <div *ngIf="isPanelExpanded(i)" class="lorebook-panel-content">
                <div class="lorebook-form-grid">

                  <!-- Title Field -->
                  <div class="form-group">
                    <label [for]="'lorebook-' + i + '-title'" class="form-label">
                      Title
                      <span class="required">*</span>
                    </label>
                    <input
                      [class.error]="lorebookCtrl.get('title')?.invalid && lorebookCtrl.get('title')?.touched"
                      [id]="'lorebook-' + i + '-title'"
                      class="form-input"
                      formControlName="title"
                      placeholder="Enter lorebook title"
                      type="text"
                    />
                    <div *ngIf="lorebookCtrl.get('title')?.invalid && lorebookCtrl.get('title')?.touched"
                         class="field-error">
                      <span *ngIf="lorebookCtrl.get('title')?.errors?.['required']">Title is required</span>
                      <span *ngIf="lorebookCtrl.get('title')?.errors?.['maxlength']">Title must not exceed 200 characters</span>
                    </div>
                  </div>

                  <!-- Category Field -->
                  <div class="form-group">
                    <label [for]="'lorebook-' + i + '-category'" class="form-label">
                      Category
                      <span class="required">*</span>
                    </label>
                    <input
                      [class.error]="lorebookCtrl.get('category')?.invalid && lorebookCtrl.get('category')?.touched"
                      [id]="'lorebook-' + i + '-category'"
                      class="form-input"
                      formControlName="category"
                      placeholder="e.g., Characters, Locations, History"
                      type="text"
                    />
                    <div *ngIf="lorebookCtrl.get('category')?.invalid && lorebookCtrl.get('category')?.touched"
                         class="field-error">
                      <span *ngIf="lorebookCtrl.get('category')?.errors?.['required']">Category is required</span>
                      <span *ngIf="lorebookCtrl.get('category')?.errors?.['maxlength']">Category must not exceed 100 characters</span>
                    </div>
                  </div>

                  <!-- Content Type Field -->
                  <div class="form-group">
                    <label [for]="'lorebook-' + i + '-contentType'" class="form-label">
                      Content Type
                      <span class="required">*</span>
                    </label>
                    <select
                      [class.error]="lorebookCtrl.get('contentType')?.invalid && lorebookCtrl.get('contentType')?.touched"
                      [id]="'lorebook-' + i + '-contentType'"
                      class="form-input"
                      formControlName="contentType"
                    >
                      <option value="txt">Text</option>
                      <option value="json">JSON</option>
                    </select>
                    <div *ngIf="lorebookCtrl.get('contentType')?.invalid && lorebookCtrl.get('contentType')?.touched"
                         class="field-error">
                      <span
                        *ngIf="lorebookCtrl.get('contentType')?.errors?.['required']">Content type is required</span>
                    </div>
                  </div>

                  <!-- Content Field -->
                  <div class="form-group">
                    <label [for]="'lorebook-' + i + '-content'" class="form-label">
                      Content
                      <span class="required">*</span>
                    </label>
                    <textarea
                      [class.error]="lorebookCtrl.get('content')?.invalid && lorebookCtrl.get('content')?.touched"
                      [id]="'lorebook-' + i + '-content'"
                      class="form-textarea"
                      formControlName="content"
                      placeholder="Enter lorebook content..."
                      rows="6"
                    ></textarea>
                    <div *ngIf="lorebookCtrl.get('content')?.invalid && lorebookCtrl.get('content')?.touched"
                         class="field-error">
                      <span *ngIf="lorebookCtrl.get('content')?.errors?.['required']">Content is required</span>
                      <span *ngIf="lorebookCtrl.get('content')?.errors?.['minlength']">Content must be at least 10 characters</span>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button (click)="cancel()" [disabled]="saving" class="btn-cancel" type="button">
            Cancel
          </button>
          <button [disabled]="saving || worldbookForm.invalid" class="btn-submit" type="submit">
            <svg *ngIf="saving" [attr.fill]="'none'" class="btn-spinner" viewBox="0 0 24 24">
              <circle [attr.cx]="12" [attr.cy]="12" [attr.r]="10" [attr.stroke-width]="4" [attr.stroke]="'currentColor'"
                      class="opacity-25"></circle>
              <path
                [attr.d]="'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'"
                [attr.fill]="'currentColor'" class="opacity-75"></path>
            </svg>
            <span>{{ saving ? 'Saving...' : (isEditMode ? 'Update Worldbook' : 'Create Worldbook') }}</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
