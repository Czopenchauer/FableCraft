<div class="worldbook-manager">
  <!-- Success Toast -->
  <div *ngIf="successMessage" class="success-toast">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    {{ successMessage }}
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="loading-content">
      <svg class="spinner" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke-width="4" stroke="currentColor" class="opacity-25"></circle>
        <path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor" class="opacity-75"></path>
      </svg>
      <p class="loading-text">Loading worldbook...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-banner">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
    </svg>
    <span>{{ error }}</span>
    <button (click)="error = null" class="btn-close-error" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
      </svg>
    </button>
  </div>

  <!-- Main Form -->
  <form *ngIf="!loading" [formGroup]="worldbookForm" (ngSubmit)="onSubmit()" class="manager-form">
    <!-- Two Panel Layout -->
    <div class="two-panel-layout">
      <!-- LEFT PANEL: Worldbook Settings + Lorebook List -->
      <div class="left-panel">
        <!-- Header -->
        <div class="panel-header">
          <button (click)="cancel()" class="back-button" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M10 19l-7-7m0 0l7-7m-7 7h18" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
            </svg>
          </button>
          <h1 class="panel-title">{{ isEditMode ? 'Edit Worldbook' : 'Create Worldbook' }}</h1>
        </div>

        <!-- Worldbook Settings -->
        <div class="worldbook-settings" [class.disabled]="!canEdit">
          <!-- Name Field -->
          <div class="form-group">
            <label class="form-label" for="name">
              Worldbook Name <span class="required">*</span>
            </label>
            <input
              [class.error]="nameControl?.invalid && nameControl?.touched"
              class="form-input"
              formControlName="name"
              id="name"
              placeholder="Enter worldbook name"
              type="text"
              [readonly]="!canEdit"
            />
            <div *ngIf="nameControl?.invalid && nameControl?.touched" class="field-error">
              <span *ngIf="nameControl?.errors?.['required']">Worldbook name is required</span>
              <span *ngIf="nameControl?.errors?.['maxlength']">Max 200 characters</span>
            </div>
          </div>

          <!-- GraphRAG Settings -->
          <div class="form-group">
            <label class="form-label" for="graphRagSettingsId">GraphRAG Settings</label>
            <div class="custom-dropdown settings-dropdown" [class.open]="graphRagDropdownOpen" [class.disabled]="!canEdit">
              <button type="button" class="dropdown-trigger" (click)="canEdit && toggleGraphRagDropdown()" [disabled]="!canEdit">
                <span>{{ getSelectedGraphRagName() }}</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="dropdown-arrow">
                  <path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <div class="dropdown-options" *ngIf="graphRagDropdownOpen">
                <button type="button" class="dropdown-option" [class.selected]="worldbookForm.get('graphRagSettingsId')?.value === null" (click)="selectGraphRagSettings(null)">-- None --</button>
                <button type="button" *ngFor="let settings of graphRagSettingsOptions" class="dropdown-option" [class.selected]="worldbookForm.get('graphRagSettingsId')?.value === settings.id" (click)="selectGraphRagSettings(settings.id)">
                  {{ settings.name }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Pending Changes Banner -->
        <div *ngIf="indexingStatus === 'NeedsReindexing'" class="pending-changes-banner">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Pending changes need re-indexing</span>
          <button (click)="revertAllChanges()" [disabled]="reverting" class="btn-revert-all" type="button">
            {{ reverting ? 'Reverting...' : 'Revert All' }}
          </button>
        </div>

        <!-- Duplicate Titles Warning -->
        <div *ngIf="hasDuplicateTitles()" class="duplicate-warning-banner">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Lorebook titles must be unique. Please fix duplicate titles before saving.</span>
        </div>

        <!-- Lorebooks Section -->
        <div class="lorebooks-section">
          <div class="section-header">
            <h3 class="section-title">Lorebooks</h3>
            <div class="section-actions">
              <button (click)="triggerFileInput()" [disabled]="saving || !canEdit" class="btn-icon" title="Import JSON" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                </svg>
              </button>
              <button (click)="addLorebook()" [disabled]="saving || !canEdit" class="btn-add" type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                </svg>
                Add
              </button>
            </div>
          </div>

          <!-- Hidden file input -->
          <input (change)="onFileSelected($event)" accept=".json" id="json-file-input" style="display: none;" type="file"/>

          <!-- Import Error -->
          <div *ngIf="importError" class="import-error">
            <span>{{ importError }}</span>
            <button (click)="importError = null" type="button">&times;</button>
          </div>

          <!-- Toolbar -->
          <div class="lorebooks-toolbar" *ngIf="lorebooks.length > 0">
            <div class="toolbar-search">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <input type="text" placeholder="Search..." [(ngModel)]="searchTerm" [ngModelOptions]="{standalone: true}" (input)="applyFilters()">
            </div>
            <!-- Custom Sort Dropdown -->
            <div class="custom-dropdown" [class.open]="sortDropdownOpen">
              <button type="button" class="dropdown-trigger" (click)="toggleSortDropdown()">
                <span>{{ getSortLabel() }}</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="dropdown-arrow">
                  <path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <div class="dropdown-options" *ngIf="sortDropdownOpen">
                <button type="button" class="dropdown-option" [class.selected]="sortOption === 'title-asc'" (click)="selectSortOption('title-asc')">A-Z</button>
                <button type="button" class="dropdown-option" [class.selected]="sortOption === 'title-desc'" (click)="selectSortOption('title-desc')">Z-A</button>
                <button type="button" class="dropdown-option" [class.selected]="sortOption === 'category-asc'" (click)="selectSortOption('category-asc')">Category</button>
                <button type="button" class="dropdown-option" [class.selected]="sortOption === 'status'" (click)="selectSortOption('status')">Status</button>
              </div>
            </div>
          </div>

          <!-- Filter Chips -->
          <div class="filter-chips" *ngIf="lorebooks.length > 0">
            <button [class.active]="statusFilter === 'all'" (click)="setStatusFilter('all')" type="button">
              All <span class="count">{{ lorebooks.length }}</span>
            </button>
            <button *ngIf="addedCount > 0" [class.active]="statusFilter === 'Added'" (click)="setStatusFilter('Added')" type="button" class="chip-added">
              Added <span class="count">{{ addedCount }}</span>
            </button>
            <button *ngIf="modifiedCount > 0" [class.active]="statusFilter === 'Modified'" (click)="setStatusFilter('Modified')" type="button" class="chip-modified">
              Modified <span class="count">{{ modifiedCount }}</span>
            </button>
            <button *ngIf="deletedCount > 0" [class.active]="statusFilter === 'Deleted'" (click)="setStatusFilter('Deleted')" type="button" class="chip-deleted">
              Deleted <span class="count">{{ deletedCount }}</span>
            </button>
          </div>

          <!-- Lorebook List -->
          <div class="lorebook-list" formArrayName="lorebooks">
            <!-- Empty State -->
            <div *ngIf="lorebooks.length === 0" class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
              </svg>
              <p>No lorebooks yet</p>
            </div>

            <!-- No Results -->
            <div *ngIf="lorebooks.length > 0 && filteredIndices.length === 0" class="no-results">
              <p>No matches found</p>
              <button (click)="searchTerm = ''; statusFilter = 'all'; applyFilters()" type="button">Clear filters</button>
            </div>

            <!-- Lorebook Items -->
            <div *ngFor="let i of filteredIndices; trackBy: trackByFilteredIndex"
                 [formGroupName]="i"
                 class="lorebook-item"
                 [class.selected]="isLorebookSelected(i)"
                 [class.is-deleted]="isLorebookDeleted(i)"
                 [class.is-added]="isLorebookAdded(i) && !isLorebookDeleted(i)"
                 [class.is-modified]="isLorebookModified(i) && !isLorebookDeleted(i)"
                 (click)="selectLorebook(i)">

              <div class="item-content">
                <span class="item-title" [class.deleted-title]="isLorebookDeleted(i)">
                  {{ getLorebookTitle(i) }}
                </span>
                <span *ngIf="getLorebookCategory(i)" class="item-category">{{ getLorebookCategory(i) }}</span>
              </div>

              <div class="item-badges">
                <span *ngIf="isDuplicateTitle(i)" class="badge duplicate" title="Duplicate title">DUP</span>
                <span *ngIf="isLorebookDeleted(i)" class="badge deleted">DEL</span>
                <span *ngIf="isLorebookAdded(i) && !isLorebookDeleted(i)" class="badge added">NEW</span>
                <span *ngIf="isLorebookModified(i) && !isLorebookDeleted(i)" class="badge modified">MOD</span>
                <span *ngIf="isLorebookIndexed(i)" class="badge indexed" title="Indexed (read-only)">IDX</span>
              </div>

              <div class="item-actions" *ngIf="canEdit">
                <!-- Restore button for deleted -->
                <button *ngIf="isLorebookDeleted(i)"
                        (click)="restoreLorebookByIndex(i); $event.stopPropagation()"
                        class="btn-action restore"
                        title="Restore"
                        type="button">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <!-- Copy button for indexed entries -->
                <button *ngIf="isLorebookIndexed(i) && !isLorebookDeleted(i)"
                        (click)="copyLorebook(i); $event.stopPropagation()"
                        class="btn-action copy"
                        title="Copy to new lorebook"
                        type="button">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <!-- Delete button for non-deleted -->
                <button *ngIf="!isLorebookDeleted(i)"
                        (click)="deleteLorebook(i); $event.stopPropagation()"
                        class="btn-action delete"
                        title="Delete"
                        type="button">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Status Banner -->
        <div *ngIf="indexingStatus === 'Indexing'" class="status-banner indexing">
          <svg class="spinner-small" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke-width="4" stroke="currentColor" class="opacity-25"></circle>
            <path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor" class="opacity-75"></path>
          </svg>
          <span>Indexing in progress...</span>
        </div>
        <div *ngIf="indexingStatus === 'Failed'" class="status-banner failed">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
          </svg>
          <span>Indexing failed</span>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
          <button (click)="cancel()" [disabled]="saving" class="btn-cancel" type="button">Back</button>

          <!-- Create mode: Show Create button -->
          <button *ngIf="!isEditMode" [disabled]="saving || worldbookForm.invalid || hasDuplicateTitles()" class="btn-submit" type="submit">
            <svg *ngIf="saving" class="btn-spinner" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" stroke-width="4" stroke="currentColor" class="opacity-25"></circle>
              <path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor" class="opacity-75"></path>
            </svg>
            {{ saving ? 'Creating...' : 'Create' }}
          </button>

          <!-- Edit mode: Show Save button -->
          <button *ngIf="isEditMode && canEdit"
                  (click)="performSave()"
                  [disabled]="saving || worldbookForm.invalid || hasDuplicateTitles()"
                  class="btn-submit"
                  type="button">
            <svg *ngIf="saving" class="btn-spinner" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" stroke-width="4" stroke="currentColor" class="opacity-25"></circle>
              <path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor" class="opacity-75"></path>
            </svg>
            {{ saving ? 'Saving...' : 'Save' }}
          </button>

          <!-- Edit mode: Show Reindex button -->
          <button *ngIf="isEditMode && canReindex"
                  (click)="startReindex()"
                  [disabled]="saving || indexingStatus === 'Indexing'"
                  class="btn-reindex"
                  type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            {{ indexingStatus === 'NotIndexed' ? 'Index' : 'Re-index' }}
          </button>
        </div>
      </div>

      <!-- RIGHT PANEL: Lorebook Detail -->
      <div class="right-panel" formArrayName="lorebooks">
        <!-- No Selection State -->
        <div *ngIf="selectedLorebookIndex === null" class="no-selection">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
          </svg>
          <p>Select a lorebook to edit</p>
        </div>

        <!-- Lorebook Detail Form -->
        <div *ngIf="selectedLorebookIndex !== null" [formGroupName]="selectedLorebookIndex" class="lorebook-detail">
          <!-- Detail Header -->
          <div class="detail-header">
            <h2 class="detail-title">{{ getLorebookTitle(selectedLorebookIndex) }}</h2>
            <div class="detail-badges">
              <span *ngIf="isLorebookDeleted(selectedLorebookIndex)" class="badge deleted">Deleted</span>
              <span *ngIf="isLorebookAdded(selectedLorebookIndex) && !isLorebookDeleted(selectedLorebookIndex)" class="badge added">Added</span>
              <span *ngIf="isLorebookModified(selectedLorebookIndex) && !isLorebookDeleted(selectedLorebookIndex)" class="badge modified">Modified</span>
            </div>
            <div class="detail-actions">
              <button *ngIf="isLorebookModified(selectedLorebookIndex) && !isLorebookDeleted(selectedLorebookIndex)"
                      (click)="revertLorebook(selectedLorebookIndex)"
                      class="btn-revert"
                      title="Revert to indexed state"
                      type="button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Revert
              </button>
            </div>
          </div>

          <!-- Deleted Notice -->
          <div *ngIf="isLorebookDeleted(selectedLorebookIndex)" class="deleted-notice">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>This lorebook is marked for deletion. Changes will be applied on re-index.</span>
            <button (click)="restoreLorebookByIndex(selectedLorebookIndex)" class="btn-restore" type="button">Restore</button>
          </div>

          <!-- Indexed Notice (read-only) -->
          <div *ngIf="isLorebookIndexed(selectedLorebookIndex)" class="indexed-notice">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>This lorebook is indexed and read-only. To modify, copy it, delete the original, then re-index.</span>
            <button (click)="copyLorebook(selectedLorebookIndex)" class="btn-copy" type="button" title="Copy to new lorebook">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Copy
            </button>
          </div>

          <!-- Form Fields -->
          <div class="detail-form" [class.disabled]="isLorebookDeleted(selectedLorebookIndex) || !canEdit || isLorebookIndexed(selectedLorebookIndex)">
            <!-- Title Field -->
            <div class="form-group">
              <label [for]="'lorebook-' + selectedLorebookIndex + '-title'" class="form-label">
                Title <span class="required">*</span>
              </label>
              <input
                [class.error]="(lorebooks.at(selectedLorebookIndex).get('title')?.invalid && lorebooks.at(selectedLorebookIndex).get('title')?.touched) || isDuplicateTitle(selectedLorebookIndex)"
                [id]="'lorebook-' + selectedLorebookIndex + '-title'"
                class="form-input"
                formControlName="title"
                placeholder="Enter lorebook title"
                type="text"
              />
              <div *ngIf="lorebooks.at(selectedLorebookIndex).get('title')?.invalid && lorebooks.at(selectedLorebookIndex).get('title')?.touched" class="field-error">
                <span *ngIf="lorebooks.at(selectedLorebookIndex).get('title')?.errors?.['required']">Title is required</span>
                <span *ngIf="lorebooks.at(selectedLorebookIndex).get('title')?.errors?.['maxlength']">Max 200 characters</span>
              </div>
              <div *ngIf="isDuplicateTitle(selectedLorebookIndex)" class="field-error">
                <span>Title must be unique. Another lorebook has the same title.</span>
              </div>
            </div>

            <!-- Category Field -->
            <div class="form-group">
              <label [for]="'lorebook-' + selectedLorebookIndex + '-category'" class="form-label">
                Category <span class="required">*</span>
              </label>
              <input
                [class.error]="lorebooks.at(selectedLorebookIndex).get('category')?.invalid && lorebooks.at(selectedLorebookIndex).get('category')?.touched"
                [id]="'lorebook-' + selectedLorebookIndex + '-category'"
                class="form-input"
                formControlName="category"
                placeholder="e.g., Characters, Locations, History"
                type="text"
              />
              <div *ngIf="lorebooks.at(selectedLorebookIndex).get('category')?.invalid && lorebooks.at(selectedLorebookIndex).get('category')?.touched" class="field-error">
                <span *ngIf="lorebooks.at(selectedLorebookIndex).get('category')?.errors?.['required']">Category is required</span>
                <span *ngIf="lorebooks.at(selectedLorebookIndex).get('category')?.errors?.['maxlength']">Max 100 characters</span>
              </div>
            </div>

            <!-- Content Type Field -->
            <div class="form-group">
              <label [for]="'lorebook-' + selectedLorebookIndex + '-contentType'" class="form-label">
                Content Type <span class="required">*</span>
              </label>
              <div class="custom-dropdown content-type-dropdown" [class.open]="contentTypeDropdownOpen">
                <button type="button" class="dropdown-trigger" (click)="toggleContentTypeDropdown()">
                  <span>{{ getContentTypeLabel() }}</span>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="dropdown-arrow">
                    <path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <div class="dropdown-options" *ngIf="contentTypeDropdownOpen">
                  <button type="button" class="dropdown-option" [class.selected]="getSelectedContentType() === 'txt'" (click)="selectContentType('txt')">Text</button>
                  <button type="button" class="dropdown-option" [class.selected]="getSelectedContentType() === 'json'" (click)="selectContentType('json')">JSON</button>
                </div>
              </div>
            </div>

            <!-- Content Field -->
            <div class="form-group form-group-grow">
              <label [for]="'lorebook-' + selectedLorebookIndex + '-content'" class="form-label">
                Content <span class="required">*</span>
              </label>
              <textarea
                [class.error]="lorebooks.at(selectedLorebookIndex).get('content')?.invalid && lorebooks.at(selectedLorebookIndex).get('content')?.touched"
                [id]="'lorebook-' + selectedLorebookIndex + '-content'"
                class="form-textarea"
                formControlName="content"
                placeholder="Enter lorebook content..."
              ></textarea>
              <div *ngIf="lorebooks.at(selectedLorebookIndex).get('content')?.invalid && lorebooks.at(selectedLorebookIndex).get('content')?.touched" class="field-error">
                <span *ngIf="lorebooks.at(selectedLorebookIndex).get('content')?.errors?.['required']">Content is required</span>
                <span *ngIf="lorebooks.at(selectedLorebookIndex).get('content')?.errors?.['minlength']">Min 10 characters</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
