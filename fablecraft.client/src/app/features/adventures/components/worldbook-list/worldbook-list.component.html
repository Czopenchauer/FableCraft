<div class="worldbooks-container">
  <div class="worldbooks-content">
    <!-- Header -->
    <div class="worldbooks-header">
      <div class="header-left">
        <button (click)="goBack()" class="back-button">
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path [attr.d]="'M10 19l-7-7m0 0l7-7m-7 7h18'" [attr.stroke-linecap]="'round'"
                  [attr.stroke-linejoin]="'round'" [attr.stroke-width]="2"></path>
          </svg>
        </button>
        <h1 class="page-title">Worldbooks</h1>
      </div>
      <button (click)="createNewWorldbook()" class="btn-new-worldbook">
        <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
          <path [attr.d]="'M12 4v16m8-8H4'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                [attr.stroke-width]="2"></path>
        </svg>
        <span>New Worldbook</span>
      </button>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="loading-content">
        <svg [attr.fill]="'none'" class="spinner" viewBox="0 0 24 24">
          <circle [attr.cx]="12" [attr.cy]="12" [attr.r]="10" [attr.stroke-width]="4" [attr.stroke]="'currentColor'"
                  class="opacity-25"></circle>
          <path
            [attr.d]="'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'"
            [attr.fill]="'currentColor'" class="opacity-75"></path>
        </svg>
        <p class="loading-text">Loading worldbooks...</p>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="error-state">
      <div class="error-content">
        <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" class="error-icon" viewBox="0 0 24 24">
          <path [attr.d]="'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'" [attr.stroke-linecap]="'round'"
                [attr.stroke-linejoin]="'round'" [attr.stroke-width]="2"></path>
        </svg>
        <div class="error-text">
          <h3 class="error-title">Error Loading Worldbooks</h3>
          <p class="error-message">{{ error }}</p>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && !error && worldbooks.length === 0" class="empty-state">
      <div class="empty-content">
        <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" class="empty-icon" viewBox="0 0 24 24">
          <path
            [attr.d]="'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253'"
            [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'" [attr.stroke-width]="2"></path>
        </svg>
        <h2 class="empty-title">No Worldbooks Yet</h2>
        <p class="empty-description">
          Create your first worldbook to organize lorebooks and build rich, detailed worlds for your adventures.
        </p>
        <button (click)="createNewWorldbook()" class="btn-create-first">
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path [attr.d]="'M12 4v16m8-8H4'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                  [attr.stroke-width]="2"></path>
          </svg>
          <span>Create Your First Worldbook</span>
        </button>
      </div>
    </div>

    <!-- Worldbooks Grid -->
    <div *ngIf="!loading && worldbooks.length > 0" class="worldbooks-grid">
      <div
        (click)="editWorldbook(worldbook)"
        *ngFor="let worldbook of worldbooks"
        class="worldbook-card">
        <!-- Delete Button -->
        <button
          (click)="deleteWorldbook($event, worldbook.id, worldbook.name)"
          class="delete-button"
          title="Delete worldbook">
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path
              [attr.d]="'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16'"
              [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'" [attr.stroke-width]="2"></path>
          </svg>
        </button>

        <!-- Title and Description -->
        <h3 class="card-title">{{ worldbook.name }}</h3>
        <p class="card-description">
          {{ worldbook.lorebooks.length }} lorebook(s)
        </p>

        <!-- Index Status and Action -->
        <div class="index-section">
          <!-- Indexed Badge -->
          <div *ngIf="getIndexState(worldbook.id).status === 'Indexed'" class="index-badge indexed">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M5 13l4 4L19 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Indexed</span>
          </div>

          <!-- Not Indexed - Show Index Button -->
          <button
            *ngIf="getIndexState(worldbook.id).status === 'NotIndexed'"
            (click)="startIndexing($event, worldbook.id)"
            class="index-button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7C5 4 4 5 4 7z" stroke-width="2"/>
              <path d="M9 12h6M12 9v6" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Index</span>
          </button>

          <!-- Indexing in Progress -->
          <div *ngIf="getIndexState(worldbook.id).status === 'Indexing'" class="index-badge indexing">
            <svg class="index-spinner" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="spinner-track"/>
              <path d="M4 12a8 8 0 018-8" stroke="currentColor" stroke-width="4" stroke-linecap="round" class="spinner-arc"/>
            </svg>
            <span>Indexing...</span>
          </div>

          <!-- Failed - Show error and retry button -->
          <div *ngIf="getIndexState(worldbook.id).status === 'Failed'" class="index-failed">
            <div class="index-badge failed" [title]="getIndexState(worldbook.id).error || 'Indexing failed'">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Failed</span>
            </div>
            <button
              (click)="startIndexing($event, worldbook.id)"
              class="index-button retry">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Retry</span>
            </button>
          </div>
        </div>

        <!-- Hover Arrow -->
        <div class="card-arrow">
          <svg [attr.fill]="'none'" [attr.stroke]="'currentColor'" viewBox="0 0 24 24">
            <path [attr.d]="'M13 7l5 5m0 0l-5 5m5-5H6'" [attr.stroke-linecap]="'round'" [attr.stroke-linejoin]="'round'"
                  [attr.stroke-width]="2"></path>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <app-delete-confirmation-modal
    (cancel)="cancelDelete()"
    (confirm)="confirmDelete()"
    [adventureName]="worldbookToDelete?.name || ''"
    [isDeleting]="isDeleting"
    [isOpen]="showDeleteModal">
  </app-delete-confirmation-modal>
</div>
